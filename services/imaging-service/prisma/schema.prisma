// Imaging Service Database Schema

generator client {
  output = "./../src/generated/client"
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ImagingOrder {
  id                String    @id @default(uuid())
  patientId         String
  providerId        String
  facilityId        String
  orderNumber       String    @unique
  priority          Priority  @default(ROUTINE)
  modality          Modality
  bodyPart          String
  clinicalIndication String
  instructions      String?
  urgency           String?
  transportRequired Boolean   @default(false)
  contrastAllergy   Boolean   @default(false)
  contrastNotes     String?
  status            OrderStatus @default(PENDING)
  scheduledAt       DateTime?
  requestedBy       String
  requestedAt       DateTime  @default(now())

  studies           Study[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([patientId])
  @@index([providerId])
  @@index([facilityId])
  @@index([status])
  @@index([scheduledAt])
}

model Study {
  id                String       @id @default(uuid())
  orderId           String
  order             ImagingOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  accessionNumber   String       @unique
  studyInstanceUID  String       @unique
  studyDate         DateTime
  studyTime         String?
  studyDescription  String
  modality          Modality
  bodyPart          String
  numberOfSeries    Int          @default(0)
  numberOfInstances Int          @default(0)

  patientId         String
  patientName       String
  patientDOB        DateTime?
  patientSex        String?

  performingPhysician String?
  operatorName      String?
  institutionName   String?
  stationName       String?

  status            StudyStatus  @default(SCHEDULED)
  priority          Priority     @default(ROUTINE)

  images            Image[]
  reports           RadiologyReport[]
  criticalFindings  CriticalFinding[]

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([orderId])
  @@index([patientId])
  @@index([studyDate])
  @@index([modality])
  @@index([status])
  @@index([studyInstanceUID])
  @@index([accessionNumber])
  @@index([patientId, studyDate])
  @@index([modality, studyDate])
}

model Image {
  id                  String   @id @default(uuid())
  studyId             String
  study               Study    @relation(fields: [studyId], references: [id], onDelete: Cascade)

  seriesInstanceUID   String
  sopInstanceUID      String   @unique
  instanceNumber      Int
  seriesNumber        Int
  seriesDescription   String?

  imageType           String?
  photometricInterpretation String?
  rows                Int?
  columns             Int?
  bitsAllocated       Int?
  bitsStored          Int?
  pixelSpacing        String?
  sliceThickness      Float?
  sliceLocation       Float?
  imagePosition       String?
  imageOrientation    String?

  acquisitionDate     DateTime?
  acquisitionTime     String?
  contentDate         DateTime?
  contentTime         String?

  windowCenter        String?
  windowWidth         String?

  storageUrl          String
  thumbnailUrl        String?
  fileSize            BigInt
  transferSyntaxUID   String?

  metadata            Json?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([studyId])
  @@index([seriesInstanceUID])
}

model RadiologyReport {
  id                String       @id @default(uuid())
  studyId           String
  study             Study        @relation(fields: [studyId], references: [id], onDelete: Cascade)

  reportNumber      String       @unique
  radiologistId     String
  radiologistName   String

  status            ReportStatus @default(PRELIMINARY)

  clinicalHistory   String?
  technique         String?
  comparison        String?
  findings          String
  impression        String
  recommendations   String?

  preliminaryDate   DateTime?
  finalizedDate     DateTime?
  amendedDate       DateTime?
  amendmentReason   String?

  signedBy          String?
  signedAt          DateTime?

  transcribedBy     String?
  transcribedAt     DateTime?

  template          String?
  macros            Json?

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([studyId])
  @@index([radiologistId])
  @@index([status])
}

model CriticalFinding {
  id                String         @id @default(uuid())
  studyId           String
  study             Study          @relation(fields: [studyId], references: [id], onDelete: Cascade)

  reportId          String?

  finding           String
  severity          Severity
  category          String
  bodyPart          String?

  reportedBy        String
  reportedAt        DateTime       @default(now())

  notifiedTo        String[]
  notificationSent  Boolean        @default(false)
  acknowledgedBy    String?
  acknowledgedAt    DateTime?

  followUpRequired  Boolean        @default(true)
  followUpAction    String?
  followUpStatus    String?

  notes             String?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([studyId])
  @@index([severity])
  @@index([notificationSent])
}

enum Priority {
  STAT
  URGENT
  ROUTINE
}

enum Modality {
  CR          // Computed Radiography
  CT          // Computed Tomography
  MR          // Magnetic Resonance
  US          // Ultrasound
  XA          // X-Ray Angiography
  DX          // Digital Radiography
  MG          // Mammography
  NM          // Nuclear Medicine
  PT          // Positron Emission Tomography
  PET_CT      // PET-CT
  RF          // Radiofluoroscopy
  OT          // Other
}

enum OrderStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum StudyStatus {
  SCHEDULED
  ARRIVED
  IN_PROGRESS
  COMPLETED
  PRELIMINARY
  FINAL
  CANCELLED
}

enum ReportStatus {
  PRELIMINARY
  FINAL
  AMENDED
  CORRECTED
}

enum Severity {
  CRITICAL
  HIGH
  MODERATE
  LOW
}

// ==========================================
// PACS Integration Tables
// ==========================================

model PACSNode {
  id              String   @id @default(uuid())
  name            String   @unique
  description     String?
  aeTitle         String   @unique // Application Entity Title
  hostname        String
  port            Int      @default(104)

  // Node type and capabilities
  nodeType        PACSNodeType @default(SCP)
  isActive        Boolean  @default(true)

  // TLS/Security
  tlsEnabled      Boolean  @default(false)
  tlsCertPath     String?

  // Connection settings
  maxAssociations Int      @default(10)
  timeout         Int      @default(30) // seconds

  // Supported transfer syntaxes
  transferSyntaxes String[]

  // Supported SOP Classes
  sopClasses      String[]

  // Metadata
  lastConnectedAt DateTime?
  lastErrorAt     DateTime?
  lastError       String?

  // Relations
  dicomTransfers  DicomTransfer[]
  worklistItems   WorklistItem[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([aeTitle])
  @@index([isActive])
  @@index([nodeType])
  @@index([hostname, port])
}

model DicomTransfer {
  id              String   @id @default(uuid())

  // Source and destination
  sourceNodeId    String?
  sourceNode      PACSNode? @relation(fields: [sourceNodeId], references: [id], onDelete: SetNull)
  destinationAE   String

  // DICOM references
  studyInstanceUID    String
  seriesInstanceUID   String?
  sopInstanceUID      String?

  // Transfer details
  transferType    TransferType
  direction       TransferDirection
  status          TransferStatus @default(PENDING)

  // Progress tracking
  totalInstances  Int      @default(0)
  completedInstances Int   @default(0)
  failedInstances Int      @default(0)

  // Timing
  scheduledAt     DateTime?
  startedAt       DateTime?
  completedAt     DateTime?

  // Error handling
  retryCount      Int      @default(0)
  maxRetries      Int      @default(3)
  lastError       String?
  errorDetails    Json?

  // Metadata
  priority        Int      @default(5) // 1-10, lower is higher priority
  initiatedBy     String?
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sourceNodeId])
  @@index([studyInstanceUID])
  @@index([status])
  @@index([transferType])
  @@index([scheduledAt])
  @@index([priority])
  @@index([status, priority])
}

model WorklistItem {
  id                  String   @id @default(uuid())

  // Associated PACS node
  pacsNodeId          String?
  pacsNode            PACSNode? @relation(fields: [pacsNodeId], references: [id], onDelete: SetNull)

  // Scheduled Procedure Step
  scheduledProcedureStepId String @unique
  scheduledStartDate  DateTime
  scheduledStartTime  String?
  modality            Modality
  scheduledStation    String?
  scheduledPerformingPhysician String?

  // Requested Procedure
  requestedProcedureId String
  requestedProcedureDescription String
  accessionNumber     String   @unique

  // Patient Information (for worklist query)
  patientId           String
  patientName         String
  patientDOB          DateTime?
  patientSex          String?

  // Referring Physician
  referringPhysician  String?
  referringPhysicianId String?

  // Order Information
  orderId             String?
  orderPriority       Priority @default(ROUTINE)

  // Status
  status              WorklistStatus @default(SCHEDULED)

  // Timing
  arrivedAt           DateTime?
  startedAt           DateTime?
  completedAt         DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([pacsNodeId])
  @@index([scheduledStartDate])
  @@index([modality])
  @@index([patientId])
  @@index([accessionNumber])
  @@index([status])
  @@index([orderId])
  @@index([scheduledStartDate, modality])
}

model StorageLocation {
  id              String   @id @default(uuid())
  name            String   @unique
  description     String?

  // Storage type
  storageType     StorageType

  // Configuration
  basePath        String?  // For local/NAS storage
  bucketName      String?  // For S3/GCS/Azure
  region          String?
  endpoint        String?  // Custom S3-compatible endpoint

  // Credentials (encrypted)
  accessKeyId     String?
  secretAccessKey String?

  // Storage settings
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)
  maxSizeGB       BigInt?
  usedSizeGB      BigInt   @default(0)

  // Retention policy
  retentionDays   Int?     // null = infinite
  archiveAfterDays Int?

  // Health check
  lastHealthCheck DateTime?
  isHealthy       Boolean  @default(true)
  healthCheckError String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([storageType])
  @@index([isActive])
  @@index([isDefault])
}

model DicomTag {
  id              String   @id @default(uuid())
  tag             String   @unique // Format: (0008,0050) - human readable
  tagHex          String   @unique // Format: 00080050 - hex
  name            String
  keyword         String   @unique
  vr              String   // Value Representation (CS, LO, PN, etc.)
  vm              String   // Value Multiplicity
  description     String?

  // Categorization
  category        String?  // Patient, Study, Series, Instance, etc.
  isRequired      Boolean  @default(false)
  isSearchable    Boolean  @default(false)
  isPHI           Boolean  @default(false) // Protected Health Information

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([isSearchable])
  @@index([isPHI])
}

// ==========================================
// PACS Enums
// ==========================================

enum PACSNodeType {
  SCP     // Storage Class Provider (receiver)
  SCU     // Storage Class User (sender)
  BOTH    // Both SCP and SCU
  QUERY   // Query/Retrieve only
  PRINT   // Print server
}

enum TransferType {
  STORE       // C-STORE
  QUERY       // C-FIND
  RETRIEVE    // C-MOVE or C-GET
  ECHO        // C-ECHO (verification)
}

enum TransferDirection {
  INBOUND
  OUTBOUND
}

enum TransferStatus {
  PENDING
  QUEUED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  RETRY_SCHEDULED
}

enum WorklistStatus {
  SCHEDULED
  ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum StorageType {
  LOCAL
  NAS
  S3
  GCS
  AZURE_BLOB
  CUSTOM
}
