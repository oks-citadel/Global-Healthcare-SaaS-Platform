generator client {
  output = "./../src/generated/client"
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Chronic Care Domain
// ==========================================

model CarePlan {
  id              String       @id @default(uuid())
  patientId       String
  providerId      String
  condition       String
  status          PlanStatus   @default(active)
  startDate       DateTime     @default(now())
  endDate         DateTime?
  goals           Json
  interventions   Json
  reviewSchedule  String?
  nextReviewDate  DateTime?

  // Relations
  tasks           CareTask[]
  vitals          VitalReading[]
  alerts          Alert[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([patientId])
  @@index([providerId])
  @@index([status])
  @@index([nextReviewDate])
}

enum PlanStatus {
  active
  completed
  suspended
  cancelled
}

model CareTask {
  id              String       @id @default(uuid())
  carePlanId      String
  carePlan        CarePlan     @relation(fields: [carePlanId], references: [id], onDelete: Cascade)
  title           String
  description     String?
  taskType        TaskType
  frequency       String
  dueDate         DateTime?
  completedAt     DateTime?
  status          TaskStatus   @default(pending)
  notes           String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([carePlanId])
  @@index([status])
  @@index([dueDate])
}

enum TaskType {
  medication
  measurement
  exercise
  diet
  appointment
  other
}

enum TaskStatus {
  pending
  completed
  missed
  cancelled
}

model MonitoringDevice {
  id              String       @id @default(uuid())
  patientId       String
  deviceType      DeviceType
  manufacturer    String?
  model           String?
  serialNumber    String       @unique
  status          DeviceStatus @default(active)
  lastSyncAt      DateTime?
  batteryLevel    Int?

  readings        VitalReading[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([patientId])
  @@index([deviceType])
  @@index([status])
  @@index([serialNumber])
}

enum DeviceType {
  blood_pressure_monitor
  glucose_meter
  pulse_oximeter
  weight_scale
  thermometer
  heart_rate_monitor
  peak_flow_meter
  ecg_monitor
}

enum DeviceStatus {
  active
  inactive
  maintenance
  decommissioned
}

model VitalReading {
  id              String           @id @default(uuid())
  patientId       String
  carePlanId      String?
  carePlan        CarePlan?        @relation(fields: [carePlanId], references: [id], onDelete: SetNull)
  deviceId        String?
  device          MonitoringDevice? @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  vitalType       VitalType
  value           Float
  unit            String
  isAbnormal      Boolean          @default(false)
  notes           String?
  recordedAt      DateTime         @default(now())

  createdAt       DateTime         @default(now())

  @@index([patientId])
  @@index([carePlanId])
  @@index([deviceId])
  @@index([vitalType])
  @@index([recordedAt])
  @@index([patientId, recordedAt])
}

enum VitalType {
  blood_pressure_systolic
  blood_pressure_diastolic
  heart_rate
  blood_glucose
  oxygen_saturation
  temperature
  weight
  respiratory_rate
  peak_flow
}

model Alert {
  id              String       @id @default(uuid())
  patientId       String
  carePlanId      String?
  carePlan        CarePlan?    @relation(fields: [carePlanId], references: [id], onDelete: SetNull)
  alertType       AlertType
  severity        AlertSeverity
  title           String
  description     String
  status          AlertStatus  @default(new)
  acknowledgedBy  String?
  acknowledgedAt  DateTime?
  resolvedAt      DateTime?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([patientId])
  @@index([carePlanId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

enum AlertType {
  vital_out_of_range
  missed_medication
  missed_measurement
  device_offline
  no_activity
  threshold_exceeded
}

enum AlertSeverity {
  info
  warning
  critical
}

enum AlertStatus {
  new
  acknowledged
  resolved
  dismissed
}

model Goal {
  id              String       @id @default(uuid())
  patientId       String
  carePlanId      String?
  title           String
  description     String?
  goalType        GoalType
  targetValue     Float?
  targetUnit      String?
  targetDate      DateTime?
  frequency       String?
  status          GoalStatus   @default(active)
  completedAt     DateTime?

  progress        GoalProgress[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([patientId])
  @@index([carePlanId])
  @@index([status])
  @@index([goalType])
}

model GoalProgress {
  id              String       @id @default(uuid())
  goalId          String
  goal            Goal         @relation(fields: [goalId], references: [id], onDelete: Cascade)
  value           Float
  currentValue    Float?
  currentUnit     String?
  notes           String?
  recordedAt      DateTime     @default(now())

  createdAt       DateTime     @default(now())

  @@index([goalId])
  @@index([recordedAt])
}

enum GoalType {
  vital_sign
  activity
  lifestyle
  clinical_outcome
  weight_loss
  blood_pressure
  blood_glucose
  exercise
  medication_adherence
  diet
  sleep
  stress_management
  other
}

enum GoalStatus {
  achieved
  active
  completed
  paused
  cancelled
}

model AlertThreshold {
  id              String       @id @default(uuid())
  patientId       String
  carePlanId      String?
  vitalType       VitalType
  condition       String?
  minValue        Float?
  maxValue        Float?
  criticalMin     Float?
  criticalMax     Float?
  warningMin      Float?
  warningMax      Float?
  isActive        Boolean      @default(true)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([patientId])
  @@index([vitalType])
  @@index([isActive])
}

model CarePlanTemplate {
  id              String       @id @default(uuid())
  name            String
  description     String?
  condition       String
  goals           Json
  interventions   Json
  tasks           Json?
  reviewSchedule  String?
  thresholds      Json?
  version         Int          @default(1)
  isActive        Boolean      @default(true)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([condition])
  @@index([isActive])
}

model PatientEngagement {
  id              String           @id @default(uuid())
  patientId       String
  carePlanId      String?
  engagementType  EngagementType
  activityType    String
  description     String?
  metadata        Json?
  recordedAt      DateTime         @default(now())

  createdAt       DateTime         @default(now())

  @@index([patientId])
  @@index([carePlanId])
  @@index([engagementType])
  @@index([recordedAt])
}

enum EngagementType {
  device_sync
  vital_reading
  goal_progress
  medication_taken
  appointment_kept
  task_completed
  education_viewed
  message_sent
  other
}
