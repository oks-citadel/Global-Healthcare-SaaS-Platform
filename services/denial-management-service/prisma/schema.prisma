generator client {
  output   = "./../src/generated/client"
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Denial Domain
// ==========================================

model Denial {
  id                    String           @id @default(uuid())
  claimId               String
  patientId             String
  providerId            String
  payerId               String
  payerName             String

  // X12 835 Remittance Advice fields
  claimStatus           ClaimStatus      @default(denied)
  denialDate            DateTime         @default(now())
  serviceDate           DateTime
  billedAmount          Decimal          @db.Decimal(12, 2)
  allowedAmount         Decimal?         @db.Decimal(12, 2)
  paidAmount            Decimal?         @db.Decimal(12, 2)
  patientResponsibility Decimal?         @db.Decimal(12, 2)

  // CARC/RARC Codes (Claim Adjustment Reason Code / Remittance Advice Remark Code)
  carcCode              String           // Primary CARC code (e.g., CO-4, CO-16, PR-1)
  carcDescription       String
  rarcCodes             String[]         // Additional RARC codes
  groupCode             String           // CO, OA, PI, PR

  // Procedure and diagnosis codes
  procedureCode         String           // CPT/HCPCS code
  procedureModifiers    String[]
  diagnosisCodes        String[]         // ICD-10 codes
  placeOfService        String?

  // X12 277 Claim Status fields
  x277StatusCode        String?          // Claim status category code
  x277StatusMessage     String?

  // AI prediction data
  predictedRecoverable  Boolean          @default(false)
  recoveryProbability   Float?           // 0-1 probability score
  riskFactors           Json?            // JSON array of risk factors

  // Categorization
  denialCategory        DenialCategory
  rootCause             String?

  // Revenue tracking
  recoveredAmount       Decimal?         @db.Decimal(12, 2)
  writeOffAmount        Decimal?         @db.Decimal(12, 2)

  // Relationships
  appeals               Appeal[]

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([claimId])
  @@index([patientId])
  @@index([providerId])
  @@index([payerId])
  @@index([carcCode])
  @@index([denialCategory])
  @@index([denialDate])
  @@index([claimStatus])
  @@index([procedureCode])
}

enum ClaimStatus {
  pending
  denied
  partially_denied
  appealed
  appeal_pending
  appeal_approved
  appeal_denied
  recovered
  written_off
}

enum DenialCategory {
  prior_authorization      // Missing or invalid prior auth
  medical_necessity        // Service not medically necessary
  coding_error             // Incorrect CPT/ICD codes
  duplicate_claim          // Claim already processed
  timely_filing            // Claim filed too late
  eligibility              // Patient not eligible
  coordination_of_benefits // COB issues
  bundling                 // Services should be bundled
  modifier_issue           // Missing or incorrect modifiers
  documentation            // Insufficient documentation
  non_covered_service      // Service not covered by plan
  out_of_network           // Provider not in network
  benefit_exhausted        // Benefits maxed out
  pre_existing_condition   // Pre-existing condition exclusion
  other                    // Other/unknown
}

// ==========================================
// Appeal Domain
// ==========================================

model Appeal {
  id                    String           @id @default(uuid())
  denialId              String
  denial                Denial           @relation(fields: [denialId], references: [id], onDelete: Cascade)

  // Appeal details
  appealLevel           Int              @default(1) // 1st level, 2nd level, external review
  appealType            AppealType
  status                AppealStatus     @default(draft)

  // Payer-specific strategy
  payerAppealStrategy   Json?            // Payer-specific requirements and tips

  // Generated content
  appealLetterContent   String?          @db.Text
  appealLetterHtml      String?          @db.Text
  supportingDocuments   String[]         // Document IDs/URLs

  // Key dates
  filingDeadline        DateTime
  submittedDate         DateTime?
  responseDeadline      DateTime?
  responseDate          DateTime?

  // Outcome
  outcome               AppealOutcome?
  outcomeReason         String?
  adjustedAmount        Decimal?         @db.Decimal(12, 2)

  // Staff tracking
  assignedTo            String?          // Staff member ID
  assignedAt            DateTime?
  completedBy           String?
  completedAt           DateTime?

  // Processing time (for productivity metrics)
  processingTimeMinutes Int?

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([denialId])
  @@index([status])
  @@index([appealLevel])
  @@index([assignedTo])
  @@index([filingDeadline])
  @@index([submittedDate])
}

enum AppealType {
  clinical_review
  administrative_review
  peer_to_peer
  external_review
  expedited
}

enum AppealStatus {
  draft
  pending_review
  approved_for_submission
  submitted
  pending_response
  additional_info_requested
  resolved
  closed
}

enum AppealOutcome {
  overturned_full       // Full payment received
  overturned_partial    // Partial payment received
  upheld                // Denial upheld
  withdrawn             // Appeal withdrawn
  expired               // Filing deadline missed
}

// ==========================================
// Denial Pattern Analytics
// ==========================================

model DenialPattern {
  id                    String           @id @default(uuid())

  // Pattern identification
  payerId               String
  payerName             String
  procedureCode         String?          // CPT/HCPCS
  diagnosisCode         String?          // ICD-10
  carcCode              String?
  denialCategory        DenialCategory?

  // Statistics
  totalDenials          Int              @default(0)
  totalBilledAmount     Decimal          @db.Decimal(14, 2) @default(0)
  totalRecoveredAmount  Decimal          @db.Decimal(14, 2) @default(0)
  denialRate            Float            @default(0)
  recoveryRate          Float            @default(0)
  averageRecoveryTime   Int?             // Days

  // Time period
  periodStart           DateTime
  periodEnd             DateTime

  // Trend data
  monthlyTrend          Json?            // Array of {month, count, amount}

  // AI insights
  suggestedActions      String[]
  riskScore             Float?           // 0-100 risk score for this pattern

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@unique([payerId, procedureCode, diagnosisCode, carcCode, periodStart, periodEnd])
  @@index([payerId])
  @@index([procedureCode])
  @@index([diagnosisCode])
  @@index([carcCode])
  @@index([denialCategory])
  @@index([denialRate])
}

// ==========================================
// Payer Configuration
// ==========================================

model PayerConfig {
  id                    String           @id @default(uuid())
  payerId               String           @unique
  payerName             String

  // Appeal requirements
  firstLevelDeadlineDays   Int           @default(60)
  secondLevelDeadlineDays  Int           @default(60)
  externalReviewDeadlineDays Int         @default(120)

  // Payer-specific requirements
  requiresClinicalNotes    Boolean       @default(true)
  requiresMedicalRecords   Boolean       @default(false)
  requiresLetterOfMedicalNecessity Boolean @default(false)
  acceptsElectronicAppeals Boolean       @default(true)

  // Contact information
  appealAddress         Json?            // Mailing address
  appealFaxNumber       String?
  appealEmail           String?
  appealPortalUrl       String?

  // Appeal letter preferences
  preferredFormat       String?          // PDF, physical mail, portal
  specialInstructions   String?

  // Historical success rates
  firstLevelSuccessRate Float?
  secondLevelSuccessRate Float?
  externalReviewSuccessRate Float?

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([payerName])
}

// ==========================================
// Staff Productivity Tracking
// ==========================================

model StaffProductivity {
  id                    String           @id @default(uuid())
  staffId               String
  staffName             String

  // Period
  periodDate            DateTime         @db.Date

  // Denial metrics
  denialsReviewed       Int              @default(0)
  denialsAssigned       Int              @default(0)

  // Appeal metrics
  appealsCreated        Int              @default(0)
  appealsSubmitted      Int              @default(0)
  appealsOverturned     Int              @default(0)
  appealsUpheld         Int              @default(0)

  // Time metrics
  averageProcessingTime Int?             // Minutes
  totalProcessingTime   Int              @default(0) // Minutes

  // Revenue metrics
  totalRecovered        Decimal          @db.Decimal(14, 2) @default(0)

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@unique([staffId, periodDate])
  @@index([staffId])
  @@index([periodDate])
}

// ==========================================
// Revenue Recovery Tracking
// ==========================================

model RevenueRecovery {
  id                    String           @id @default(uuid())

  // Period
  periodStart           DateTime
  periodEnd             DateTime

  // Denial metrics
  totalDenials          Int              @default(0)
  totalDeniedAmount     Decimal          @db.Decimal(14, 2) @default(0)

  // Appeal metrics
  totalAppeals          Int              @default(0)
  successfulAppeals     Int              @default(0)

  // Recovery metrics
  totalRecovered        Decimal          @db.Decimal(14, 2) @default(0)
  totalWrittenOff       Decimal          @db.Decimal(14, 2) @default(0)
  recoveryRate          Float            @default(0)

  // Breakdown by category
  recoveryByCategory    Json?            // {category: amount}
  recoveryByPayer       Json?            // {payerId: amount}

  // Trend data
  weeklyBreakdown       Json?            // Array of weekly stats

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@unique([periodStart, periodEnd])
  @@index([periodStart])
  @@index([periodEnd])
}

// ==========================================
// Pre-submission Risk Assessment
// ==========================================

model ClaimRiskAssessment {
  id                    String           @id @default(uuid())
  claimId               String           @unique

  // Claim details
  patientId             String
  providerId            String
  payerId               String
  procedureCode         String
  diagnosisCodes        String[]
  billedAmount          Decimal          @db.Decimal(12, 2)

  // Risk assessment
  overallRiskScore      Float            // 0-100
  riskLevel             RiskLevel

  // Risk factors
  riskFactors           Json             // Array of {factor, score, description}

  // Recommendations
  recommendations       String[]
  suggestedModifications Json?           // Suggested claim modifications

  // Assessment outcome
  assessmentDate        DateTime         @default(now())
  wasSubmitted          Boolean          @default(false)
  wasModified           Boolean          @default(false)
  actualOutcome         String?          // paid, denied, partial

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([claimId])
  @@index([patientId])
  @@index([payerId])
  @@index([riskLevel])
  @@index([assessmentDate])
}

enum RiskLevel {
  low         // 0-25
  moderate    // 26-50
  high        // 51-75
  critical    // 76-100
}
