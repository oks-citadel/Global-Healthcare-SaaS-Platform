generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Appointments & Visits (Telehealth Domain)
// ==========================================

model Appointment {
  id             String            @id @default(uuid())
  patientId      String
  providerId     String
  scheduledAt    DateTime
  duration       Int // in minutes
  type           AppointmentType
  status         AppointmentStatus @default(scheduled)
  reasonForVisit String?
  notes          String?

  // Relations
  visit Visit?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([providerId])
  @@index([scheduledAt])
  @@index([status])
  @@index([patientId, scheduledAt])
  @@index([providerId, scheduledAt])
}

enum AppointmentType {
  video
  audio
  chat
  in_person
}

enum AppointmentStatus {
  scheduled
  confirmed
  in_progress
  completed
  cancelled
  no_show
}

model Visit {
  id            String      @id @default(uuid())
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  sessionToken  String      @unique
  status        VisitStatus @default(waiting)
  startedAt     DateTime?
  endedAt       DateTime?

  // WebRTC connection info
  roomId        String      @unique
  iceServers    Json?

  // Relations
  messages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([appointmentId])
  @@index([sessionToken])
  @@index([status])
  @@index([roomId])
}

enum VisitStatus {
  waiting
  in_progress
  completed
  cancelled
}

model ChatMessage {
  id          String   @id @default(uuid())
  visitId     String
  visit       Visit    @relation(fields: [visitId], references: [id], onDelete: Cascade)
  senderId    String
  senderRole  String   // patient, provider
  message     String
  attachments String[]
  timestamp   DateTime @default(now())

  @@index([visitId])
  @@index([timestamp])
  @@index([visitId, timestamp])
}

model ProviderAvailability {
  id         String   @id @default(uuid())
  providerId String
  dayOfWeek  Int      // 0-6 (Sunday-Saturday)
  startTime  String   // HH:MM format
  endTime    String   // HH:MM format
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([providerId])
  @@index([providerId, dayOfWeek])
  @@index([isActive])
}

model ProviderBreak {
  id         String   @id @default(uuid())
  providerId String
  startTime  DateTime
  endTime    DateTime
  reason     String?

  createdAt  DateTime @default(now())

  @@index([providerId])
  @@index([startTime, endTime])
}
