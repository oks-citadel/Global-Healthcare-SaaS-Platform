# ============================================
# UnifiedHealth Web Frontend - NPM-based Build
# ============================================

# Stage 1: Build SDK
FROM node:25-alpine AS sdk-builder

WORKDIR /app/packages/sdk

# Copy SDK source and dependencies
COPY packages/sdk/package.json packages/sdk/tsconfig.json ./
COPY packages/sdk/src ./src

# Install SDK dependencies and build
RUN npm install --legacy-peer-deps && npm run build

# Stage 2: Build Web App
FROM node:25-alpine AS builder

RUN apk add --no-cache libc6-compat && rm -rf /var/cache/apk/*

WORKDIR /app

# Copy web app package.json (will modify SDK dependency)
COPY apps/web/package.json ./package.json.original

# Modify package.json to use local SDK path
RUN cat package.json.original | sed 's/"@unified-health\/sdk": "workspace:\*"/"@unified-health\/sdk": "file:..\/packages\/sdk"/g' > package.json

# Copy SDK built output
COPY --from=sdk-builder /app/packages/sdk ../packages/sdk

# Install web dependencies
RUN npm install --legacy-peer-deps

# Copy web app source
COPY apps/web/ ./

# Set environment
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production

# Build Next.js
RUN npm run build

# Stage 3: Production Runtime
FROM node:25-alpine AS production

LABEL maintainer="UnifiedHealth Platform Team"
LABEL version="1.0.0"
LABEL description="UnifiedHealth Patient Portal - Next.js"

RUN apk add --no-cache dumb-init ca-certificates wget \
    && apk upgrade --no-cache \
    && rm -rf /var/cache/apk/*

WORKDIR /app

RUN addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001 -G nodejs

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Copy standalone build
COPY --from=builder --chown=nodejs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nodejs:nodejs /app/.next/static ./.next/static
COPY --from=builder --chown=nodejs:nodejs /app/public ./public

USER nodejs

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1

ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "server.js"]
