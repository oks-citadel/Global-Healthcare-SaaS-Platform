#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# ============================================
# UnifiedHealth Platform - Pre-commit Hook
# Security checks before allowing commits
# ============================================

echo "üîí Running security checks..."

# Run lint-staged (includes ESLint with security rules)
pnpm lint-staged

# Secret detection with Gitleaks
if command -v gitleaks &> /dev/null; then
    echo "üîç Scanning for secrets with Gitleaks..."
    if gitleaks protect --staged --verbose; then
        echo "‚úÖ No secrets detected"
    else
        echo "‚ùå Secrets detected! Please remove them before committing."
        echo "If this is a false positive, add to .gitleaks.toml allowlist"
        exit 1
    fi
else
    echo "‚ö†Ô∏è  Gitleaks not installed. Install with: brew install gitleaks"
    echo "Skipping secret detection..."
fi

# Check for common security issues in package.json
if git diff --cached --name-only | grep -q "package.json"; then
    echo "üîç Checking package.json for security issues..."

    # Check for unsafe scripts
    if git diff --cached package.json | grep -E "(preinstall|postinstall)" | grep -v "husky install"; then
        echo "‚ö†Ô∏è  Warning: Pre/post install scripts detected in package.json"
        echo "Please review for security implications"
    fi

    # Run npm audit if package.json or lock file changed
    echo "üîç Running npm audit..."
    if pnpm audit --audit-level=high 2>/dev/null; then
        echo "‚úÖ No high/critical vulnerabilities"
    else
        echo "‚ö†Ô∏è  Vulnerabilities found. Run 'pnpm audit' for details"
        # Don't fail the commit, just warn
    fi
fi

# Check for .env files (should never be committed)
if git diff --cached --name-only | grep -E "^\.env$|^\.env\.[^e]"; then
    echo "‚ùå Error: .env files should never be committed!"
    echo "Detected files:"
    git diff --cached --name-only | grep -E "^\.env$|^\.env\.[^e]"
    echo ""
    echo "Please unstage these files:"
    echo "  git reset HEAD .env*"
    exit 1
fi

# Check for common secret patterns in committed files
echo "üîç Scanning staged files for common secrets..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|yml|yaml)$' || true)

if [ -n "$STAGED_FILES" ]; then
    # Check for AWS keys
    if echo "$STAGED_FILES" | xargs grep -nE "AKIA[0-9A-Z]{16}" 2>/dev/null; then
        echo "‚ùå Possible AWS Access Key detected!"
        exit 1
    fi

    # Check for private keys
    if echo "$STAGED_FILES" | xargs grep -l "BEGIN.*PRIVATE KEY" 2>/dev/null; then
        echo "‚ùå Private key detected!"
        exit 1
    fi

    # Check for database URLs with passwords
    if echo "$STAGED_FILES" | xargs grep -nE "(mongodb|mysql|postgres)://[^:]+:[^@]+@" 2>/dev/null | grep -v "example\|sample\|test"; then
        echo "‚ö†Ô∏è  Database connection string with credentials detected"
        echo "Please use environment variables instead"
    fi
fi

echo "‚úÖ Pre-commit security checks passed"
