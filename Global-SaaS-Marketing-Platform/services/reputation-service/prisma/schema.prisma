generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Reviews
model Review {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  source        String    // google, yelp, facebook, trustpilot, internal
  externalId    String?   @map("external_id")
  authorName    String    @map("author_name")
  authorEmail   String?   @map("author_email")
  rating        Float
  title         String?
  content       String    @db.Text
  response      String?   @db.Text
  respondedAt   DateTime? @map("responded_at")
  respondedBy   String?   @map("responded_by")
  sentiment     String?   // positive, negative, neutral
  sentimentScore Float?   @map("sentiment_score")
  isVerified    Boolean   @default(false) @map("is_verified")
  isPublished   Boolean   @default(true) @map("is_published")
  isFeatured    Boolean   @default(false) @map("is_featured")
  tags          Json      @default("[]")
  metadata      Json      @default("{}")
  publishedAt   DateTime  @map("published_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, source, externalId])
  @@index([tenantId, source])
  @@index([tenantId, rating])
  @@index([tenantId, sentiment])
  @@index([tenantId, publishedAt])
  @@map("reviews")
}

// Testimonials
model Testimonial {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  customerId      String?   @map("customer_id")
  customerName    String    @map("customer_name")
  customerTitle   String?   @map("customer_title")
  customerCompany String?   @map("customer_company")
  customerPhoto   String?   @map("customer_photo")
  content         String    @db.Text
  videoUrl        String?   @map("video_url")
  rating          Float?
  category        String?
  tags            Json      @default("[]")
  isApproved      Boolean   @default(false) @map("is_approved")
  approvedBy      String?   @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  isFeatured      Boolean   @default(false) @map("is_featured")
  displayOrder    Int       @default(0) @map("display_order")
  metadata        Json      @default("{}")
  submittedAt     DateTime  @default(now()) @map("submitted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([tenantId, isApproved])
  @@index([tenantId, isFeatured])
  @@index([tenantId, category])
  @@map("testimonials")
}

// NPS Surveys
model NpsSurvey {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  trigger     String    // manual, post_purchase, post_support, scheduled
  triggerConfig Json?   @map("trigger_config")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  responses   NpsResponse[]

  @@index([tenantId, isActive])
  @@map("nps_surveys")
}

model NpsResponse {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  surveyId      String    @map("survey_id")
  customerId    String?   @map("customer_id")
  customerEmail String?   @map("customer_email")
  score         Int       // 0-10
  category      String    // promoter, passive, detractor
  feedback      String?   @db.Text
  tags          Json      @default("[]")
  followUpSent  Boolean   @default(false) @map("follow_up_sent")
  followUpAt    DateTime? @map("follow_up_at")
  metadata      Json      @default("{}")
  submittedAt   DateTime  @default(now()) @map("submitted_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  survey        NpsSurvey @relation(fields: [surveyId], references: [id])

  @@index([tenantId, surveyId])
  @@index([tenantId, category])
  @@index([tenantId, submittedAt])
  @@map("nps_responses")
}

// CSAT Surveys
model CsatSurvey {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        String
  description String?
  question    String
  scaleType   String    @map("scale_type") // 1-5, 1-7, emoji
  isActive    Boolean   @default(true) @map("is_active")
  trigger     String    // manual, post_interaction, post_ticket
  triggerConfig Json?   @map("trigger_config")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  responses   CsatResponse[]

  @@index([tenantId, isActive])
  @@map("csat_surveys")
}

model CsatResponse {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  surveyId      String    @map("survey_id")
  customerId    String?   @map("customer_id")
  customerEmail String?   @map("customer_email")
  score         Int
  maxScore      Int       @map("max_score")
  feedback      String?   @db.Text
  interactionId String?   @map("interaction_id")
  interactionType String? @map("interaction_type")
  tags          Json      @default("[]")
  metadata      Json      @default("{}")
  submittedAt   DateTime  @default(now()) @map("submitted_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  survey        CsatSurvey @relation(fields: [surveyId], references: [id])

  @@index([tenantId, surveyId])
  @@index([tenantId, submittedAt])
  @@map("csat_responses")
}

// Trust Badges
model TrustBadge {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        String
  type        String    // certification, award, partnership, verification
  issuer      String
  imageUrl    String    @map("image_url")
  linkUrl     String?   @map("link_url")
  description String?
  issuedAt    DateTime? @map("issued_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([tenantId, type])
  @@index([tenantId, isActive])
  @@map("trust_badges")
}

// Social Mentions
model SocialMention {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  platform      String    // twitter, linkedin, facebook, instagram, reddit
  externalId    String    @map("external_id")
  authorName    String    @map("author_name")
  authorHandle  String?   @map("author_handle")
  authorFollowers Int?    @map("author_followers")
  content       String    @db.Text
  url           String?
  sentiment     String?   // positive, negative, neutral
  sentimentScore Float?   @map("sentiment_score")
  reach         Int?
  engagement    Json?     // likes, shares, comments
  tags          Json      @default("[]")
  isResponded   Boolean   @default(false) @map("is_responded")
  respondedAt   DateTime? @map("responded_at")
  metadata      Json      @default("{}")
  mentionedAt   DateTime  @map("mentioned_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, platform, externalId])
  @@index([tenantId, platform])
  @@index([tenantId, sentiment])
  @@index([tenantId, mentionedAt])
  @@map("social_mentions")
}

// Rating Aggregates (cached statistics)
model RatingAggregate {
  id                String    @id @default(uuid())
  tenantId          String    @map("tenant_id")
  source            String    // all, google, yelp, etc.
  period            String    // all_time, month, quarter, year
  periodStart       DateTime? @map("period_start")
  periodEnd         DateTime? @map("period_end")
  totalReviews      Int       @map("total_reviews")
  averageRating     Float     @map("average_rating")
  ratingDistribution Json     @map("rating_distribution") // {1: count, 2: count, ...}
  sentimentDistribution Json  @map("sentiment_distribution")
  npsScore          Float?    @map("nps_score")
  csatScore         Float?    @map("csat_score")
  responseRate      Float?    @map("response_rate")
  avgResponseTime   Float?    @map("avg_response_time")
  calculatedAt      DateTime  @default(now()) @map("calculated_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, source, period, periodStart])
  @@index([tenantId, source])
  @@map("rating_aggregates")
}
