// Growth Service Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CAMPAIGNS ====================

model Campaign {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        CampaignType
  status      CampaignStatus @default(DRAFT)
  budget      Decimal? @db.Decimal(10, 2)
  currency    String   @default("USD")
  startDate   DateTime?
  endDate     DateTime?
  targetAudience Json?
  goals       Json?
  channels    String[]
  tags        String[]
  metadata    Json?

  // Metrics
  impressions Int      @default(0)
  clicks      Int      @default(0)
  conversions Int      @default(0)
  spend       Decimal  @default(0) @db.Decimal(10, 2)
  revenue     Decimal  @default(0) @db.Decimal(10, 2)

  // Relations
  utmLinks    UtmLink[]
  landingPages CampaignLandingPage[]

  // Audit
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  @@map("campaigns")
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

enum CampaignType {
  EMAIL
  SOCIAL
  PPC
  CONTENT
  AFFILIATE
  REFERRAL
  INFLUENCER
  RETARGETING
  BRAND_AWARENESS
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

// ==================== UTM TRACKING ====================

model UtmLink {
  id          String   @id @default(uuid())
  campaignId  String?
  campaign    Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  originalUrl String
  shortCode   String   @unique
  fullUrl     String

  // UTM Parameters
  utmSource   String
  utmMedium   String
  utmCampaign String
  utmTerm     String?
  utmContent  String?

  // Tracking
  clicks      Int      @default(0)
  uniqueClicks Int     @default(0)
  lastClickedAt DateTime?

  // Metadata
  metadata    Json?
  expiresAt   DateTime?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("utm_links")
  @@index([shortCode])
  @@index([campaignId])
}

// ==================== LANDING PAGES ====================

model LandingPage {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  status      LandingPageStatus @default(DRAFT)

  // Content
  title       String
  headline    String?
  subheadline String?
  content     Json?
  template    String?
  customCss   String?
  customJs    String?

  // SEO
  metaTitle       String?
  metaDescription String?
  ogImage         String?
  canonicalUrl    String?

  // Settings
  conversionGoal  String?
  thankYouUrl     String?
  formFields      Json?

  // Tracking
  views       Int      @default(0)
  uniqueViews Int      @default(0)
  conversions Int      @default(0)
  bounceRate  Decimal? @db.Decimal(5, 2)
  avgTimeOnPage Int?

  // Relations
  variants    LandingPageVariant[]
  abTests     ABTest[]
  campaigns   CampaignLandingPage[]

  // Audit
  publishedAt DateTime?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  @@map("landing_pages")
  @@index([slug])
  @@index([status])
}

enum LandingPageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model LandingPageVariant {
  id            String   @id @default(uuid())
  landingPageId String
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  name          String
  variantCode   String
  changes       Json

  // Metrics
  views         Int      @default(0)
  conversions   Int      @default(0)
  conversionRate Decimal? @db.Decimal(5, 4)

  isControl     Boolean  @default(false)
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  abTestVariants ABTestVariant[]

  @@unique([landingPageId, variantCode])
  @@map("landing_page_variants")
}

model CampaignLandingPage {
  id            String   @id @default(uuid())
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  landingPageId String
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  isPrimary     Boolean  @default(false)

  createdAt     DateTime @default(now())

  @@unique([campaignId, landingPageId])
  @@map("campaign_landing_pages")
}

// ==================== A/B TESTING ====================

model ABTest {
  id            String   @id @default(uuid())
  name          String
  description   String?
  landingPageId String?
  landingPage   LandingPage? @relation(fields: [landingPageId], references: [id], onDelete: SetNull)

  status        ABTestStatus @default(DRAFT)
  type          ABTestType   @default(SPLIT)

  // Configuration
  trafficSplit  Json?
  targetSampleSize Int?
  confidenceLevel Decimal @default(0.95) @db.Decimal(3, 2)

  // Duration
  startDate     DateTime?
  endDate       DateTime?

  // Results
  winningVariantId String?
  statisticalSignificance Decimal? @db.Decimal(5, 4)
  conclusionNotes String?

  // Relations
  variants      ABTestVariant[]

  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?

  @@map("ab_tests")
  @@index([status])
}

enum ABTestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  ARCHIVED
}

enum ABTestType {
  SPLIT
  MULTIVARIATE
  BANDIT
}

model ABTestVariant {
  id          String   @id @default(uuid())
  abTestId    String
  abTest      ABTest   @relation(fields: [abTestId], references: [id], onDelete: Cascade)
  variantId   String?
  variant     LandingPageVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  name        String
  trafficPercentage Decimal @db.Decimal(5, 2)

  // Metrics
  visitors    Int      @default(0)
  conversions Int      @default(0)
  conversionRate Decimal? @db.Decimal(5, 4)

  isControl   Boolean  @default(false)
  isWinner    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ab_test_variants")
}

// ==================== REFERRALS ====================

model ReferralProgram {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      ReferralProgramStatus @default(ACTIVE)

  // Rewards
  referrerReward    Decimal  @db.Decimal(10, 2)
  refereeReward     Decimal  @db.Decimal(10, 2)
  rewardType        RewardType @default(CREDIT)
  rewardCurrency    String   @default("USD")

  // Rules
  maxRedemptions    Int?
  minPurchaseAmount Decimal? @db.Decimal(10, 2)
  expirationDays    Int?

  // Limits
  maxReferralsPerUser Int?
  totalBudget       Decimal? @db.Decimal(10, 2)
  currentSpend      Decimal  @default(0) @db.Decimal(10, 2)

  // Relations
  referralCodes     ReferralCode[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("referral_programs")
}

enum ReferralProgramStatus {
  ACTIVE
  PAUSED
  ENDED
}

enum RewardType {
  CREDIT
  DISCOUNT_PERCENT
  DISCOUNT_FIXED
  FREE_TRIAL
  POINTS
}

model ReferralCode {
  id              String   @id @default(uuid())
  programId       String
  program         ReferralProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  code            String   @unique
  referrerId      String

  // Tracking
  totalClicks     Int      @default(0)
  totalSignups    Int      @default(0)
  totalConversions Int     @default(0)
  totalRewardsEarned Decimal @default(0) @db.Decimal(10, 2)

  isActive        Boolean  @default(true)
  expiresAt       DateTime?

  // Relations
  redemptions     ReferralRedemption[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("referral_codes")
  @@index([code])
  @@index([referrerId])
}

model ReferralRedemption {
  id              String   @id @default(uuid())
  referralCodeId  String
  referralCode    ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)

  refereeId       String
  status          RedemptionStatus @default(PENDING)

  // Rewards
  referrerRewardAmount Decimal? @db.Decimal(10, 2)
  refereeRewardAmount  Decimal? @db.Decimal(10, 2)
  referrerRewardPaidAt DateTime?
  refereeRewardPaidAt  DateTime?

  metadata        Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?

  @@map("referral_redemptions")
  @@index([refereeId])
  @@index([status])
}

enum RedemptionStatus {
  PENDING
  QUALIFIED
  REWARDED
  EXPIRED
  CANCELLED
}

// ==================== AFFILIATES ====================

model AffiliateProgram {
  id              String   @id @default(uuid())
  name            String
  description     String?
  status          AffiliateProgramStatus @default(ACTIVE)

  // Commission
  commissionType  CommissionType @default(PERCENTAGE)
  commissionRate  Decimal  @db.Decimal(5, 2)
  minPayout       Decimal  @default(50) @db.Decimal(10, 2)
  payoutFrequency PayoutFrequency @default(MONTHLY)

  // Cookie
  cookieDuration  Int      @default(30) // days

  // Terms
  termsUrl        String?

  // Relations
  affiliates      Affiliate[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("affiliate_programs")
}

enum AffiliateProgramStatus {
  ACTIVE
  PAUSED
  CLOSED
}

enum CommissionType {
  PERCENTAGE
  FIXED
  TIERED
}

enum PayoutFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
}

model Affiliate {
  id              String   @id @default(uuid())
  programId       String
  program         AffiliateProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  userId          String
  affiliateCode   String   @unique
  status          AffiliateStatus @default(PENDING)

  // Profile
  companyName     String?
  website         String?
  promotionMethods String[]

  // Payment
  paypalEmail     String?
  bankDetails     Json?
  taxId           String?

  // Metrics
  totalClicks     Int      @default(0)
  totalConversions Int     @default(0)
  totalRevenue    Decimal  @default(0) @db.Decimal(10, 2)
  totalCommission Decimal  @default(0) @db.Decimal(10, 2)
  pendingCommission Decimal @default(0) @db.Decimal(10, 2)

  // Relations
  conversions     AffiliateConversion[]
  payouts         AffiliatePayout[]

  approvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("affiliates")
  @@index([affiliateCode])
  @@index([userId])
}

enum AffiliateStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

model AffiliateConversion {
  id              String   @id @default(uuid())
  affiliateId     String
  affiliate       Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  orderId         String?
  customerId      String?

  orderAmount     Decimal  @db.Decimal(10, 2)
  commissionAmount Decimal @db.Decimal(10, 2)
  status          ConversionStatus @default(PENDING)

  // Tracking
  clickId         String?
  ipAddress       String?
  userAgent       String?

  metadata        Json?

  approvedAt      DateTime?
  paidAt          DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("affiliate_conversions")
  @@index([affiliateId])
  @@index([status])
}

enum ConversionStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

model AffiliatePayout {
  id              String   @id @default(uuid())
  affiliateId     String
  affiliate       Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  status          PayoutStatus @default(PENDING)
  method          String?

  transactionId   String?
  notes           String?

  processedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("affiliate_payouts")
  @@index([affiliateId])
  @@index([status])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ==================== REWARDS ====================

model Reward {
  id              String   @id @default(uuid())
  name            String
  description     String?
  type            RewardType
  value           Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")

  // Conditions
  minSpend        Decimal? @db.Decimal(10, 2)
  maxRedemptions  Int?
  validFrom       DateTime?
  validUntil      DateTime?

  // Usage
  totalRedemptions Int     @default(0)
  totalValue      Decimal  @default(0) @db.Decimal(10, 2)

  isActive        Boolean  @default(true)

  // Relations
  userRewards     UserReward[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("rewards")
}

model UserReward {
  id              String   @id @default(uuid())
  rewardId        String
  reward          Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  userId          String
  code            String?  @unique
  status          UserRewardStatus @default(AVAILABLE)

  earnedFrom      String?  // referral, affiliate, campaign, etc.
  sourceId        String?

  redeemedAt      DateTime?
  expiresAt       DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("user_rewards")
  @@index([userId])
  @@index([status])
}

enum UserRewardStatus {
  AVAILABLE
  REDEEMED
  EXPIRED
  CANCELLED
}
