# =============================================================================
# Trivy IaC Security Scan Exceptions
# =============================================================================
# This file documents intentional security exceptions for the Unified Health
# Global Healthcare SaaS Platform infrastructure.
#
# Each exception is documented with:
#   - The Trivy finding ID
#   - A clear explanation of why this is intentional
#   - The specific resources affected
#   - Any compensating controls in place
#
# Last reviewed: 2026-01-21
# =============================================================================

# -----------------------------------------------------------------------------
# ALB External-Facing Configuration
# -----------------------------------------------------------------------------
# Finding: AVD-AWS-0053 - ALB is exposed to the public internet
# Affected: infrastructure/terraform-aws/modules/alb/main.tf
#
# Justification:
# The Application Load Balancer is intentionally external-facing to serve the
# public healthcare portal. This is a core business requirement for:
#   - Patient portal access (web and mobile)
#   - Provider portal access
#   - Public API endpoints for partner integrations
#
# Compensating controls:
#   - AWS WAF rules protect against OWASP Top 10 vulnerabilities
#   - AWS Shield Advanced provides DDoS protection
#   - TLS 1.3 enforced with ELBSecurityPolicy-TLS13-1-2-2021-06
#   - CloudFront origin validation using X-CloudFront-Secret header
#   - Rate limiting at WAF and application layers
# -----------------------------------------------------------------------------
AVD-AWS-0053

# -----------------------------------------------------------------------------
# ALB Invalid Header Fields Configuration
# -----------------------------------------------------------------------------
# Finding: AVD-AWS-0052 - ALB does not drop invalid header fields
# Affected: infrastructure/terraform-aws/modules/alb/main.tf
#
# Justification:
# This finding is a FALSE POSITIVE. The drop_invalid_header_fields attribute
# IS enabled (set to true) in the aws_lb.main resource at line 32.
# Trivy may report this before evaluating the actual configuration.
#
# Verification command:
#   grep -A 20 'resource "aws_lb" "main"' infrastructure/terraform-aws/modules/alb/main.tf
# -----------------------------------------------------------------------------
AVD-AWS-0052

# -----------------------------------------------------------------------------
# Security Group Public Egress Rules
# -----------------------------------------------------------------------------
# Finding: AVD-AWS-0104 - Security group allows egress to 0.0.0.0/0
# Affected:
#   - infrastructure/terraform-aws/modules/alb/main.tf (ALB egress)
#   - infrastructure/terraform-aws/modules/ecs-cluster/main.tf (ECS tasks)
#   - infrastructure/terraform-aws/modules/ecs-fargate/main.tf (ECS tasks)
#   - infrastructure/terraform-aws/modules/vpc/main.tf (VPC endpoints)
#
# Justification:
# ECS Fargate tasks and supporting infrastructure require internet access for:
#   1. ECR image pulls (when not using VPC endpoints)
#   2. CloudWatch Logs API calls
#   3. Secrets Manager API calls
#   4. AWS KMS API calls
#   5. X-Ray telemetry submission
#   6. Third-party API integrations (payment processors, identity providers)
#
# Compensating controls:
#   - Tasks run in private subnets (no public IP assignment)
#   - NAT Gateway provides controlled internet access
#   - VPC Flow Logs enabled for traffic monitoring
#   - Security groups restrict ingress to ALB only
#   - Network ACLs provide additional layer of defense
#
# Note: VPC Endpoints are configured for ECR, S3, and Secrets Manager to
# minimize internet traffic, but egress rules remain for services without
# endpoint support and third-party integrations.
# -----------------------------------------------------------------------------
AVD-AWS-0104

# -----------------------------------------------------------------------------
# Public Ingress Rules for ALB
# -----------------------------------------------------------------------------
# Finding: AVD-AWS-0107 - Security group allows ingress from 0.0.0.0/0
# Affected: infrastructure/terraform-aws/modules/alb/main.tf
#
# Justification:
# The public-facing ALB MUST accept traffic from the internet on ports 80 and 443:
#   - Port 443 (HTTPS): Primary healthcare portal access
#   - Port 80 (HTTP): Redirects to HTTPS for SEO and user convenience
#
# Compensating controls:
#   - WAF rules block malicious traffic patterns
#   - Rate limiting prevents abuse
#   - TLS 1.3 enforced on HTTPS
#   - HTTP immediately redirects to HTTPS
# -----------------------------------------------------------------------------
AVD-AWS-0107

# -----------------------------------------------------------------------------
# KMS Key Policy Wildcard Actions
# -----------------------------------------------------------------------------
# Finding: AVD-AWS-0057 - IAM policy should not use wildcards for actions
# Affected:
#   - infrastructure/terraform-aws/modules/s3/main.tf (S3 KMS key)
#   - infrastructure/terraform-aws/modules/cloudwatch/main.tf (CloudWatch KMS key)
#   - infrastructure/terraform-aws/modules/secrets-manager/main.tf (Secrets KMS key)
#   - infrastructure/terraform-aws/modules/sns-sqs/main.tf (SNS/SQS KMS key)
#   - infrastructure/terraform-aws/modules/security/main.tf (CloudTrail KMS key)
#   - infrastructure/terraform-aws/modules/backup/vaults.tf (Backup KMS key)
#   - infrastructure/terraform-aws/modules/budgets/alerts.tf (Budget alerts KMS key)
#   - infrastructure/terraform-aws/modules/ai-security/main.tf (AI security KMS key)
#   - infrastructure/terraform-aws/modules/backup-restore-testing/main.tf (Backup testing KMS key)
#
# Justification:
# This is standard AWS KMS key policy configuration. The "kms:*" action with
# the root account principal is required by AWS for KMS key administration.
# See: https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html
#
# The wildcard grant to the root account is a standard AWS pattern that enables:
#   1. IAM policies to control key access (recommended by AWS)
#   2. Key administrators to manage the key
#   3. Prevention of key lockout scenarios
#
# Without this policy statement, the KMS key could become unmanageable if the
# creating principal is deleted.
#
# Compensating controls:
#   - Additional policy statements restrict service principals to specific actions
#   - IAM policies provide fine-grained access control
#   - CloudTrail logs all KMS key operations
#   - Key rotation is enabled on all keys
# -----------------------------------------------------------------------------
AVD-AWS-0057

# -----------------------------------------------------------------------------
# ECR GetAuthorizationToken Wildcard Resource
# -----------------------------------------------------------------------------
# Finding: AVD-AWS-0057 - IAM policy uses wildcards for resources
# Affected: infrastructure/terraform-aws/modules/ecs-fargate/main.tf
#
# Justification:
# The ecr:GetAuthorizationToken API does not support resource-level permissions.
# This is an AWS API limitation - the action must be granted with Resource: "*".
# See: https://docs.aws.amazon.com/AmazonECR/latest/userguide/security_iam_id-based-policy-examples.html
#
# The action only returns a temporary authorization token and does not grant
# access to any specific ECR repository - actual pull/push permissions are
# controlled by separate resource-scoped policies.
# -----------------------------------------------------------------------------
# Note: AVD-AWS-0057 already covers this case

# -----------------------------------------------------------------------------
# CloudWatch Logs Wildcard Resources for SSM and X-Ray
# -----------------------------------------------------------------------------
# Finding: AVD-AWS-0057 - IAM policy uses wildcards for resources
# Affected: infrastructure/terraform-aws/modules/ecs-fargate/main.tf
#
# Justification:
# ECS task roles require the following actions with Resource: "*":
#   - ssmmessages:* actions for ECS Exec functionality (debugging containers)
#   - logs:CreateLogStream and logs:PutLogEvents for application logging
#   - xray:* actions for distributed tracing
#
# These AWS APIs do not support resource-level permissions or require dynamic
# resource ARNs that are not known at deployment time.
#
# Compensating controls:
#   - Task roles only grant these permissions to ECS tasks
#   - Tasks run in private subnets with no direct internet access
#   - All API calls are logged in CloudTrail
# -----------------------------------------------------------------------------
# Note: AVD-AWS-0057 already covers this case

# =============================================================================
# Exception Review Process
# =============================================================================
# These exceptions should be reviewed:
#   - Quarterly during security audits
#   - When modifying affected infrastructure
#   - After any security incident
#   - When new Trivy versions are released (checks for false positives)
#
# To request a new exception:
#   1. Create a ticket in the security backlog
#   2. Document the business justification
#   3. Identify compensating controls
#   4. Get approval from Security and Platform teams
#   5. Add the exception with full documentation
# =============================================================================
