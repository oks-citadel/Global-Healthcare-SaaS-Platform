# =============================================================================
# The Unified Health - Asset Branding CI/CD Pipeline
# =============================================================================
# Builds, validates, and publishes the asset-branding package to ECR.
#
# Version: 1.0.0
# Last Updated: 2026-01-08
# =============================================================================

name: Asset Branding CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/asset-branding/**'
      - '.github/workflows/asset-branding.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/asset-branding/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.1)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: unified-health-prod/asset-branding
  PACKAGE_PATH: packages/asset-branding

jobs:
  # ===========================================================================
  # Validation
  # ===========================================================================
  validate:
    name: Validate Tokens
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package
        run: pnpm --filter @unified-health/asset-branding build

      - name: Validate tokens
        run: pnpm --filter @unified-health/asset-branding validate

      - name: Check TypeScript
        run: pnpm --filter @unified-health/asset-branding typecheck

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: asset-branding-dist
          path: ${{ env.PACKAGE_PATH }}/dist
          retention-days: 7

  # ===========================================================================
  # Accessibility Check
  # ===========================================================================
  accessibility:
    name: Accessibility Validation
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: asset-branding-dist
          path: ${{ env.PACKAGE_PATH }}/dist

      - name: Validate contrast ratios
        run: |
          node -e "
            const tokens = require('./${{ env.PACKAGE_PATH }}/dist/tokens.json');

            function getLuminance(hex) {
              const rgb = hex.replace('#', '').match(/.{2}/g)
                .map(x => parseInt(x, 16) / 255)
                .map(x => x <= 0.03928 ? x / 12.92 : Math.pow((x + 0.055) / 1.055, 2.4));
              return 0.2126 * rgb[0] + 0.7152 * rgb[1] + 0.0722 * rgb[2];
            }

            function getContrastRatio(c1, c2) {
              const l1 = getLuminance(c1);
              const l2 = getLuminance(c2);
              return (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05);
            }

            const textPrimary = tokens.color?.text?.primary?.\$value || '#1a1a1a';
            const surfaceCard = tokens.color?.surface?.card?.\$value || '#ffffff';

            const ratio = getContrastRatio(textPrimary, surfaceCard);
            console.log('Text on card contrast ratio:', ratio.toFixed(2) + ':1');

            if (ratio < 4.5) {
              console.error('FAIL: Contrast ratio below WCAG AA (4.5:1)');
              process.exit(1);
            }
            console.log('PASS: Meets WCAG AA requirements');
          "

  # ===========================================================================
  # Build Docker Image
  # ===========================================================================
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate, accessibility]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: asset-branding-dist
          path: ${{ env.PACKAGE_PATH }}/dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine version
        id: meta
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(node -p "require('./${{ env.PACKAGE_PATH }}/package.json').version")
          fi
          echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: v${VERSION}"

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.PACKAGE_PATH }}
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          labels: |
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Update SSM parameter
        run: |
          aws ssm put-parameter \
            --name /unified-health/prod/asset-branding/current-version \
            --value "${{ steps.meta.outputs.version }}" \
            --type String \
            --overwrite

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================================================
  # Notify Services
  # ===========================================================================
  notify:
    name: Notify Dependent Services
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - name: Trigger service rebuilds
        run: |
          echo "New asset-branding version: ${{ needs.build-image.outputs.image-tag }}"
          echo "Image digest: ${{ needs.build-image.outputs.image-digest }}"

          # Trigger dependent workflows
          for service in web-app provider-portal admin-portal; do
            echo "Triggering rebuild for ${service}..."
            # gh workflow run ${service}.yml -f branding_version=${{ needs.build-image.outputs.image-tag }}
          done

  # ===========================================================================
  # Cleanup
  # ===========================================================================
  cleanup:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: build-image
    if: always()
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Remove untagged images
        run: |
          IMAGES=$(aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --filter "tagStatus=UNTAGGED" \
            --query 'imageDetails[*].imageDigest' \
            --output text)

          for digest in $IMAGES; do
            echo "Removing untagged image: $digest"
            aws ecr batch-delete-image \
              --repository-name ${{ env.ECR_REPOSITORY }} \
              --image-ids imageDigest=$digest || true
          done
