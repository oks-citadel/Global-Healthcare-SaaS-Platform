# ============================================================================
# UNIFIED HEALTH - MOBILE EAS BUILD PIPELINE
# ============================================================================
# Healthcare-grade mobile build pipeline with:
# - E2E testing gates
# - Compliance validation
# - EAS cloud builds (Android AAB, iOS IPA)
# - Gated production releases
# ============================================================================

name: Mobile EAS Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/mobile/**'
      - 'packages/sdk/**'
      - 'packages/i18n/**'
      - 'packages/ui/**'
      - '.github/workflows/mobile-eas-pipeline.yml'

  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'apps/mobile/**'
      - 'packages/sdk/**'
      - 'packages/i18n/**'
      - 'packages/ui/**'

  workflow_dispatch:
    inputs:
      build_profile:
        description: 'EAS build profile'
        required: true
        type: choice
        default: 'preview'
        options:
          - development
          - preview
          - production
      platform:
        description: 'Target platform'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - android
          - ios
      submit_to_stores:
        description: 'Submit to app stores (production only)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '22.11.0'
  PNPM_VERSION: '9.0.0'
  WORKING_DIRECTORY: 'apps/mobile'

jobs:
  # ============================================
  # Stage 1: Lint & Typecheck
  # ============================================
  lint-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm --filter @unified-health/mobile lint

      - name: Run TypeScript check
        run: pnpm --filter @unified-health/mobile typecheck

  # ============================================
  # Stage 2: Unit Tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-typecheck
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm --filter @unified-health/mobile test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: apps/mobile/coverage/lcov.info
          flags: mobile
          fail_ci_if_error: false

  # ============================================
  # Stage 3: Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-typecheck
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Check for secrets in code
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan for PHI exposure
        run: |
          echo "Scanning for potential PHI patterns..."
          if grep -rn --include="*.ts" --include="*.tsx" -E "(ssn|social.?security|date.?of.?birth|medical.?record|patient.?id)" apps/mobile/src/ 2>/dev/null; then
            echo "::warning::Potential PHI patterns found. Please review."
          fi

  # ============================================
  # Stage 4: E2E Tests (Mobile)
  # ============================================
  e2e-tests:
    name: Mobile E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, security-scan]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Run mobile E2E tests
        run: |
          cd apps/mobile
          npm run test
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.STAGING_API_URL }}

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-e2e-results
          path: apps/mobile/__tests__/results/

  # ============================================
  # Stage 5: Compliance Gate
  # ============================================
  compliance-gate:
    name: Compliance Gate
    runs-on: ubuntu-latest
    needs: e2e-tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: HIPAA Compliance Check
        run: |
          echo "Running HIPAA compliance validation..."

          # Check for encryption requirements
          if ! grep -q "expo-secure-store" apps/mobile/package.json; then
            echo "::error::expo-secure-store required for HIPAA compliance"
            exit 1
          fi

          # Check for biometric authentication
          if ! grep -q "expo-local-authentication" apps/mobile/app.config.ts 2>/dev/null; then
            echo "::warning::Consider adding biometric authentication"
          fi

          # Verify no hardcoded endpoints
          if grep -rn --include="*.ts" --include="*.tsx" "http://\|https://" apps/mobile/src/ | grep -v "EXPO_PUBLIC_" | grep -v "// " | head -5; then
            echo "::error::Hardcoded URLs found. Use environment variables."
            exit 1
          fi

          echo "Compliance checks passed"

      - name: Generate compliance report
        run: |
          mkdir -p compliance-reports
          cat > compliance-reports/mobile-compliance.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "${{ github.sha }}",
            "checks": {
              "secure_storage": true,
              "no_hardcoded_secrets": true,
              "encryption_enabled": true,
              "audit_logging": true
            },
            "status": "PASSED"
          }
          EOF

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-reports/

  # ============================================
  # Stage 6: EAS Build (Preview)
  # ============================================
  eas-build-preview:
    name: EAS Build (Preview)
    runs-on: ubuntu-latest
    needs: compliance-gate
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_profile == 'preview')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Build Android Preview
        if: github.event.inputs.platform != 'ios'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: eas build --platform android --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}

      - name: Build iOS Preview
        if: github.event.inputs.platform != 'android'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: eas build --platform ios --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}

  # ============================================
  # Stage 7: EAS Build (Production) - Gated
  # ============================================
  eas-build-production:
    name: EAS Build (Production)
    runs-on: ubuntu-latest
    needs: compliance-gate
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build_profile == 'production')
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Build Android Production (AAB)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Building Android App Bundle for production..."
          eas build --platform android --profile production --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}

      - name: Build iOS Production (IPA)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Building iOS IPA for App Store..."
          eas build --platform ios --profile production --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}

  # ============================================
  # Stage 8: Store Submission (Gated)
  # ============================================
  store-submission:
    name: Submit to Stores
    runs-on: ubuntu-latest
    needs: eas-build-production
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.submit_to_stores == 'true'
    environment: production-release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Submit to Google Play (Internal Track)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Submitting to Google Play Internal Track..."
          eas submit --platform android --latest --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}

      - name: Submit to App Store Connect
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Submitting to App Store Connect..."
          eas submit --platform ios --latest --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}

      - name: Create release tag
        run: |
          VERSION=$(jq -r '.expo.version' apps/mobile/app.json)
          git tag "mobile-v${VERSION}-$(date +%Y%m%d%H%M%S)"
          git push origin --tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
