# ============================================
# UnifiedHealth Platform - Database Migration
# Standalone database migration workflow for on-demand execution
# ============================================

name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      migration_type:
        description: 'Migration type'
        required: true
        type: choice
        options:
          - deploy
          - rollback
          - status
          - reset
        default: deploy
      dry_run:
        description: 'Dry run (show SQL without executing)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  ACR_NAME: acrunifiedhealthdev2

jobs:
  # ==========================================
  # Pre-flight Checks
  # ==========================================
  preflight-checks:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate environment
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "Migration type: ${{ inputs.migration_type }}"
          echo "Dry run: ${{ inputs.dry_run }}"

      - name: Check database connectivity
        run: |
          # Get database connection details from Azure Key Vault
          DB_HOST=$(az keyvault secret show \
            --vault-name unified-health-kv-${{ inputs.environment }} \
            --name db-host \
            --query value -o tsv)

          echo "Database host: $DB_HOST"

          # Test connection (requires psql)
          if command -v psql &> /dev/null; then
            echo "Testing database connection..."
            # Connection test would go here
          else
            echo "psql not available, skipping connection test"
          fi

  # ==========================================
  # Backup Database (Production only)
  # ==========================================
  backup-database:
    name: Backup Database
    runs-on: ubuntu-latest
    needs: preflight-checks
    if: inputs.environment == 'production' && inputs.migration_type != 'status'
    environment: production
    outputs:
      backup_name: ${{ steps.backup.outputs.BACKUP_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create database backup
        id: backup
        run: |
          BACKUP_NAME="migration-backup-$(date +%Y%m%d-%H%M%S)"

          echo "Creating database backup: $BACKUP_NAME"

          # Create backup using Azure PostgreSQL
          az postgres flexible-server backup create \
            --resource-group unified-health-rg-${{ inputs.environment }} \
            --name unified-health-db-${{ inputs.environment }} \
            --backup-name $BACKUP_NAME \
            --retention-days 90 || echo "Using automatic backup"

          echo "BACKUP_NAME=${BACKUP_NAME}" >> $GITHUB_OUTPUT

          # Store backup name in Key Vault
          az keyvault secret set \
            --vault-name unified-health-kv-${{ inputs.environment }} \
            --name "latest-migration-backup" \
            --value "${BACKUP_NAME}" || true

      - name: Verify backup
        run: |
          echo "Verifying backup exists..."
          az postgres flexible-server backup list \
            --resource-group unified-health-rg-${{ inputs.environment }} \
            --name unified-health-db-${{ inputs.environment }} \
            --query "[?name=='${{ steps.backup.outputs.BACKUP_NAME }}']" || true

  # ==========================================
  # Run Database Migration
  # ==========================================
  run-migration:
    name: Run Migration
    runs-on: ubuntu-latest
    needs: [preflight-checks, backup-database]
    if: |
      always() &&
      needs.preflight-checks.result == 'success' &&
      (needs.backup-database.result == 'success' || needs.backup-database.result == 'skipped')
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get database credentials
        id: db-creds
        run: |
          # Retrieve database URL from Azure Key Vault
          DB_URL=$(az keyvault secret show \
            --vault-name unified-health-kv-${{ inputs.environment }} \
            --name database-url \
            --query value -o tsv)

          echo "::add-mask::$DB_URL"
          echo "DATABASE_URL=$DB_URL" >> $GITHUB_ENV

      - name: Check migration status
        if: inputs.migration_type == 'status' || inputs.dry_run
        run: |
          echo "Checking migration status..."
          pnpm --filter @unified-health/api db:migrate:status
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Deploy migrations
        if: inputs.migration_type == 'deploy' && !inputs.dry_run
        run: |
          echo "Deploying database migrations..."
          pnpm --filter @unified-health/api db:migrate:deploy
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Rollback migrations
        if: inputs.migration_type == 'rollback' && !inputs.dry_run
        run: |
          echo "Rolling back database migrations..."
          pnpm --filter @unified-health/api db:migrate:rollback
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Reset database
        if: inputs.migration_type == 'reset' && !inputs.dry_run && inputs.environment != 'production'
        run: |
          echo "Resetting database (non-production only)..."
          pnpm --filter @unified-health/api db:migrate:reset
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Generate migration SQL (dry run)
        if: inputs.dry_run
        run: |
          echo "Generating migration SQL (dry run)..."
          pnpm --filter @unified-health/api db:migrate:resolve --preview-feature
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

  # ==========================================
  # Verify Migration
  # ==========================================
  verify-migration:
    name: Verify Migration
    runs-on: ubuntu-latest
    needs: run-migration
    if: inputs.migration_type == 'deploy' && !inputs.dry_run
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get database credentials
        run: |
          DB_URL=$(az keyvault secret show \
            --vault-name unified-health-kv-${{ inputs.environment }} \
            --name database-url \
            --query value -o tsv)

          echo "::add-mask::$DB_URL"
          echo "DATABASE_URL=$DB_URL" >> $GITHUB_ENV

      - name: Verify migration status
        run: |
          echo "Verifying migration was applied..."
          pnpm --filter @unified-health/api db:migrate:status
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Run database health checks
        run: |
          echo "Running database health checks..."

          # Check table counts
          pnpm --filter @unified-health/api db:check:tables || echo "Custom check script not found"

          # Run basic query test
          echo "Database verification complete"
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

  # ==========================================
  # Rollback on Failure (Production)
  # ==========================================
  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [backup-database, run-migration, verify-migration]
    if: |
      failure() &&
      inputs.environment == 'production' &&
      inputs.migration_type == 'deploy' &&
      !inputs.dry_run
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Restore from backup
        run: |
          BACKUP_NAME="${{ needs.backup-database.outputs.backup_name }}"

          if [ -n "$BACKUP_NAME" ]; then
            echo "Restoring database from backup: $BACKUP_NAME"

            # Restore from backup
            az postgres flexible-server restore \
              --resource-group unified-health-rg-production \
              --name unified-health-db-production \
              --source-server unified-health-db-production \
              --restore-point-in-time $(date -u +"%Y-%m-%dT%H:%M:%SZ") || echo "Restore initiated"
          else
            echo "No backup name found, cannot restore"
            exit 1
          fi

      - name: Notify failure
        run: |
          echo "::error::Migration failed! Database has been restored from backup."

  # ==========================================
  # Notify Results
  # ==========================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [run-migration, verify-migration, rollback-on-failure]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.verify-migration.result }}" == "success" ] || [ "${{ needs.run-migration.result }}" == "success" ]; then
            echo "STATUS=SUCCESS" >> $GITHUB_OUTPUT
            echo "COLOR=good" >> $GITHUB_OUTPUT
          elif [ "${{ needs.rollback-on-failure.result }}" == "success" ]; then
            echo "STATUS=ROLLED_BACK" >> $GITHUB_OUTPUT
            echo "COLOR=warning" >> $GITHUB_OUTPUT
          else
            echo "STATUS=FAILED" >> $GITHUB_OUTPUT
            echo "COLOR=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Database Migration ${{ steps.status.outputs.STATUS }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.COLOR }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "${{ inputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "Migration Type",
                      "value": "${{ inputs.migration_type }}",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "${{ steps.status.outputs.STATUS }}",
                      "short": true
                    },
                    {
                      "title": "Triggered By",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Dry Run",
                      "value": "${{ inputs.dry_run }}",
                      "short": true
                    }
                  ],
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Workflow",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Send email on production failure
        if: steps.status.outputs.STATUS == 'FAILED' && inputs.environment == 'production'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "URGENT: Production Database Migration Failed"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: UnifiedHealth Platform
          body: |
            URGENT: Production database migration has failed.

            Environment: ${{ inputs.environment }}
            Migration Type: ${{ inputs.migration_type }}
            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please investigate immediately.
        continue-on-error: true
