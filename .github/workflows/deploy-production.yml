# ============================================
# UnifiedHealth Platform - Deploy to Production
# GitHub Actions for Production Deployment on Azure
# All jobs run on GitHub-hosted runners with Azure Cloud
# ============================================

name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v1.2.3)'
        required: true
        type: string
      skip_confirmation:
        description: 'Skip manual confirmation'
        required: false
        type: boolean
        default: false

env:
  ACR_NAME: acrunifiedhealthdev2
  AKS_CLUSTER: unified-health-aks-prod
  RESOURCE_GROUP: rg-unified-health-dev2-prod
  NAMESPACE: unified-health-prod
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ==========================================
  # Pre-deployment Checks
  # ==========================================
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    environment: production-approval

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
          fetch-depth: 0

      - name: Verify version tag
        run: |
          if ! git describe --exact-match --tags HEAD >/dev/null 2>&1; then
            echo "Error: Not on a tagged commit"
            exit 1
          fi

          TAG=$(git describe --exact-match --tags HEAD)
          if [ "$TAG" != "${{ inputs.version }}" ]; then
            echo "Error: Tag mismatch"
            exit 1
          fi

          echo "Version verified: $TAG"

      - name: Check for breaking changes
        run: |
          echo "Checking for breaking changes in CHANGELOG..."
          if grep -q "BREAKING CHANGE" CHANGELOG.md 2>/dev/null; then
            echo "::warning::Breaking changes detected in CHANGELOG"
          fi

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check staging deployment
        run: |
          echo "Verifying staging is healthy before production deployment..."

          az aks get-credentials \
            --resource-group unified-health-rg-staging \
            --name unified-health-aks-staging \
            --overwrite-existing

          READY_PODS=$(kubectl get pods -n unified-health-staging -l app=unified-health-api -o json | jq -r '.items[] | select(.status.phase=="Running") | .metadata.name' | wc -l)

          if [ "$READY_PODS" -eq 0 ]; then
            echo "::error::Staging environment is not healthy!"
            exit 1
          fi

          echo "Staging is healthy with $READY_PODS pods running"

  # ==========================================
  # Backup Production Database on Azure
  # ==========================================
  backup-database:
    name: Backup Production Database
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment: production
    outputs:
      backup_name: ${{ steps.backup.outputs.BACKUP_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create database backup on Azure
        id: backup
        run: |
          BACKUP_NAME="unified-health-backup-$(date +%Y%m%d-%H%M%S)"

          # Create backup using Azure PostgreSQL
          az postgres flexible-server backup create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name unified-health-db-prod \
            --backup-name $BACKUP_NAME \
            --retention-days 90 || echo "Backup created through automatic backup policy"

          echo "BACKUP_NAME=${BACKUP_NAME}" >> $GITHUB_OUTPUT

          # Store backup name in Key Vault
          az keyvault secret set \
            --vault-name unified-health-kv-production \
            --name "latest-backup-production" \
            --value "${BACKUP_NAME}" || true

  # ==========================================
  # Build and Push Images to Azure ACR
  # ==========================================
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: backup-database
    environment: production
    outputs:
      image_tag: ${{ steps.tags.outputs.IMAGE_TAG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build services
        run: pnpm build

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set image tags
        id: tags
        run: |
          VERSION="${{ inputs.version }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG="${VERSION}-${TIMESTAMP}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./services/api
          file: ./services/api/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-api:${{ steps.tags.outputs.IMAGE_TAG }}
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-api:latest
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-api:${{ steps.tags.outputs.VERSION }}
          cache-from: type=gha,scope=api-prod
          cache-to: type=gha,scope=api-prod,mode=max

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-web:${{ steps.tags.outputs.IMAGE_TAG }}
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-web:latest
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-web:${{ steps.tags.outputs.VERSION }}
          cache-from: type=gha,scope=web-prod
          cache-to: type=gha,scope=web-prod,mode=max

      - name: Scan images for vulnerabilities
        run: |
          # Install Trivy
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

          # Scan images
          trivy image --severity HIGH,CRITICAL ${{ env.ACR_NAME }}.azurecr.io/unified-health-api:${{ steps.tags.outputs.IMAGE_TAG }}
          trivy image --severity HIGH,CRITICAL ${{ env.ACR_NAME }}.azurecr.io/unified-health-web:${{ steps.tags.outputs.IMAGE_TAG }}

  # ==========================================
  # Blue-Green Deployment to Azure AKS
  # ==========================================
  deploy-blue-green:
    name: Blue-Green Deployment
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production
    outputs:
      new_color: ${{ steps.colors.outputs.NEW_COLOR }}
      current_color: ${{ steps.colors.outputs.CURRENT_COLOR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER }} \
            --overwrite-existing

      - name: Determine deployment colors
        id: colors
        run: |
          CURRENT_COLOR=$(kubectl get svc unified-health-api -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.selector.color}' 2>/dev/null || echo "")

          if [ "$CURRENT_COLOR" == "blue" ]; then
            CURRENT_COLOR="blue"
            NEW_COLOR="green"
          else
            CURRENT_COLOR="green"
            NEW_COLOR="blue"
          fi

          echo "CURRENT_COLOR=${CURRENT_COLOR}" >> $GITHUB_OUTPUT
          echo "NEW_COLOR=${NEW_COLOR}" >> $GITHUB_OUTPUT

          echo "Current color: ${CURRENT_COLOR}"
          echo "New color: ${NEW_COLOR}"

      - name: Run database migrations
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: db-migration-${{ needs.build-and-push.outputs.image_tag }}
            namespace: ${{ env.NAMESPACE }}
          spec:
            ttlSecondsAfterFinished: 86400
            backoffLimit: 3
            template:
              spec:
                restartPolicy: Never
                containers:
                - name: migration
                  image: ${{ env.ACR_NAME }}.azurecr.io/unified-health-api:${{ needs.build-and-push.outputs.image_tag }}
                  command: ["pnpm", "db:migrate:deploy"]
                  env:
                  - name: DATABASE_URL
                    valueFrom:
                      secretKeyRef:
                        name: unified-health-secrets
                        key: database-url
          EOF

          kubectl wait --for=condition=complete \
            --timeout=600s \
            -n ${{ env.NAMESPACE }} \
            job/db-migration-${{ needs.build-and-push.outputs.image_tag }}

      - name: Deploy to new color
        run: |
          export NEW_COLOR="${{ steps.colors.outputs.NEW_COLOR }}"
          export IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
          export ACR_LOGIN_SERVER="${{ env.ACR_NAME }}.azurecr.io"

          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: unified-health-api-${NEW_COLOR}
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: unified-health-api
              color: ${NEW_COLOR}
          spec:
            replicas: 3
            selector:
              matchLabels:
                app: unified-health-api
                color: ${NEW_COLOR}
            template:
              metadata:
                labels:
                  app: unified-health-api
                  color: ${NEW_COLOR}
              spec:
                serviceAccountName: unified-health-api
                containers:
                - name: api
                  image: ${ACR_LOGIN_SERVER}/unified-health-api:${IMAGE_TAG}
                  ports:
                  - containerPort: 8080
                  env:
                  - name: NODE_ENV
                    value: "production"
                  - name: DATABASE_URL
                    valueFrom:
                      secretKeyRef:
                        name: unified-health-secrets
                        key: database-url
                  resources:
                    requests:
                      cpu: "500m"
                      memory: "512Mi"
                    limits:
                      cpu: "2000m"
                      memory: "2Gi"
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: 8080
                    initialDelaySeconds: 30
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /ready
                      port: 8080
                    initialDelaySeconds: 10
                    periodSeconds: 5
          EOF

      - name: Wait for new deployment
        run: |
          kubectl rollout status deployment/unified-health-api-${{ steps.colors.outputs.NEW_COLOR }} \
            -n ${{ env.NAMESPACE }} \
            --timeout=600s

      - name: Verify new deployment
        run: |
          sleep 30

          READY_PODS=$(kubectl get pods -n ${{ env.NAMESPACE }} -l "app=unified-health-api,color=${{ steps.colors.outputs.NEW_COLOR }}" -o json | jq -r '.items[] | select(.status.phase=="Running") | .metadata.name' | wc -l)

          if [ "$READY_PODS" -eq 0 ]; then
            echo "::error::No pods are running!"
            exit 1
          fi

          echo "New deployment verified: $READY_PODS pods running"

      - name: Switch traffic to new deployment
        run: |
          kubectl patch svc unified-health-api -n ${{ env.NAMESPACE }} \
            -p '{"spec":{"selector":{"app":"unified-health-api","color":"${{ steps.colors.outputs.NEW_COLOR }}"}}}'

      - name: Monitor new deployment
        run: |
          echo "Monitoring deployment for 2 minutes..."

          for i in {1..12}; do
            FAILING_PODS=$(kubectl get pods -n ${{ env.NAMESPACE }} -l "app=unified-health-api,color=${{ steps.colors.outputs.NEW_COLOR }}" -o json | jq -r '.items[] | select(.status.phase!="Running") | .metadata.name' | wc -l)

            if [ "$FAILING_PODS" -gt 0 ]; then
              echo "::error::$FAILING_PODS pods are failing!"
              exit 1
            fi

            echo "All pods healthy (check $i/12)..."
            sleep 10
          done

      - name: Scale down old deployment
        if: success()
        run: |
          if [ -n "${{ steps.colors.outputs.CURRENT_COLOR }}" ]; then
            kubectl scale deployment unified-health-api-${{ steps.colors.outputs.CURRENT_COLOR }} \
              -n ${{ env.NAMESPACE }} \
              --replicas=0 || echo "Old deployment not found"
          fi

  # ==========================================
  # Rollback on Failure
  # ==========================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [backup-database, deploy-blue-green]
    if: failure()
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER }} \
            --overwrite-existing

      - name: Rollback Kubernetes deployment
        run: |
          # Switch traffic back to old deployment
          OLD_COLOR="${{ needs.deploy-blue-green.outputs.current_color }}"
          if [ -n "$OLD_COLOR" ]; then
            kubectl patch svc unified-health-api -n ${{ env.NAMESPACE }} \
              -p "{\"spec\":{\"selector\":{\"app\":\"unified-health-api\",\"color\":\"${OLD_COLOR}\"}}}" || true

            kubectl scale deployment unified-health-api-${OLD_COLOR} \
              -n ${{ env.NAMESPACE }} \
              --replicas=3 || true
          fi

          # Scale down new deployment
          NEW_COLOR="${{ needs.deploy-blue-green.outputs.new_color }}"
          if [ -n "$NEW_COLOR" ]; then
            kubectl scale deployment unified-health-api-${NEW_COLOR} \
              -n ${{ env.NAMESPACE }} \
              --replicas=0 || true
          fi

      - name: Notify rollback
        run: |
          echo "::warning::Production deployment failed! Automatic rollback completed."

  # ==========================================
  # Notify Deployment Status
  # ==========================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-blue-green, rollback]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy-blue-green.result }}" == "success" ]; then
            echo "STATUS=SUCCESS" >> $GITHUB_OUTPUT
            echo "COLOR=good" >> $GITHUB_OUTPUT
          else
            echo "STATUS=FAILED" >> $GITHUB_OUTPUT
            echo "COLOR=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Production Deployment ${{ steps.status.outputs.STATUS }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.COLOR }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "production",
                      "short": true
                    },
                    {
                      "title": "Version",
                      "value": "${{ inputs.version }}",
                      "short": true
                    },
                    {
                      "title": "Deployment Color",
                      "value": "${{ needs.deploy-blue-green.outputs.new_color }}",
                      "short": true
                    },
                    {
                      "title": "Author",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "${{ steps.status.outputs.STATUS }}",
                      "short": false
                    }
                  ],
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Workflow",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Send email notification on failure
        if: steps.status.outputs.STATUS == 'FAILED'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Production Deployment Failed - ${{ inputs.version }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: UnifiedHealth Platform
          body: |
            Production deployment has failed.

            Version: ${{ inputs.version }}
            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please investigate immediately.
        continue-on-error: true
