# ============================================
# UnifiedHealth Platform - Secret Scanning
# GitHub Actions for detecting secrets
# ============================================

name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ==========================================
  # Gitleaks Secret Scanning
  # ==========================================
  gitleaks:
    name: Gitleaks Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Upload Gitleaks report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # ==========================================
  # Trivy Secret Scanning
  # ==========================================
  trivy-secrets:
    name: Trivy Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy secret scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          format: 'sarif'
          output: 'trivy-secrets.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-secrets.sarif'

      - name: Generate readable report
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          format: 'table'
          output: 'trivy-secrets.txt'

      - name: Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-secrets-report
          path: trivy-secrets.txt

  # ==========================================
  # TruffleHog Secret Scanning
  # ==========================================
  trufflehog:
    name: TruffleHog Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --only-verified

  # ==========================================
  # Check for exposed .env files
  # ==========================================
  check-env-files:
    name: Check for Exposed .env Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env files
        run: |
          echo "üîç Checking for .env files..."
          if git ls-files | grep -E '^\.env$|^\.env\.[^e]'; then
            echo "‚ùå Error: .env files found in repository!"
            echo "These files should never be committed:"
            git ls-files | grep -E '^\.env$|^\.env\.[^e]'
            exit 1
          else
            echo "‚úÖ No .env files found"
          fi

      - name: Check for common secret patterns
        run: |
          echo "üîç Scanning for common secret patterns..."

          # Check for AWS keys
          if git grep -E "AKIA[0-9A-Z]{16}"; then
            echo "‚ùå Possible AWS Access Key found!"
            exit 1
          fi

          # Check for private keys
          if git grep "BEGIN.*PRIVATE KEY"; then
            echo "‚ùå Private key found!"
            exit 1
          fi

          # Check for database connection strings
          if git grep -E "(mongodb|mysql|postgres)://[^:]+:[^@]+@" | grep -vE "example|sample|test"; then
            echo "‚ö†Ô∏è  Database connection string found"
          fi

          echo "‚úÖ No obvious secrets found"

  # ==========================================
  # Validate secret management
  # ==========================================
  validate-secrets:
    name: Validate Secret Management
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets in code
        run: |
          echo "üîç Checking for hardcoded secrets..."

          # Find TypeScript/JavaScript files
          FILES=$(find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/.next/*" \
            ! -path "*/dist/*" \
            ! -path "*/build/*" \
            ! -path "*.test.*" \
            ! -path "*.spec.*")

          # Check for process.env usage (good)
          ENV_USAGE=$(echo "$FILES" | xargs grep -l "process\.env\." 2>/dev/null | wc -l)
          echo "‚úÖ Files using process.env: $ENV_USAGE"

          # Check for potential hardcoded secrets (bad)
          HARDCODED=$(echo "$FILES" | xargs grep -nE "(apiKey|api_key|secret|password)\s*[:=]\s*['\"](?!\$\{)[A-Za-z0-9]{10,}" 2>/dev/null | grep -vE "example|test|demo|sample" || true)

          if [ -n "$HARDCODED" ]; then
            echo "‚ö†Ô∏è  Potential hardcoded secrets found:"
            echo "$HARDCODED"
            echo ""
            echo "Please use environment variables instead:"
            echo "  const apiKey = process.env.API_KEY"
          fi

      - name: Check for .env.example files
        run: |
          echo "üîç Checking for .env.example files..."

          if [ -f ".env.example" ]; then
            echo "‚úÖ .env.example found"

            # Validate that .env.example doesn't contain real secrets
            if grep -qE "AKIA[0-9A-Z]{16}|ghp_[0-9a-zA-Z]{36}" .env.example; then
              echo "‚ùå Real secrets found in .env.example!"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  .env.example not found"
            echo "Consider adding one for documentation"
          fi

  # ==========================================
  # Notify on secret detection
  # ==========================================
  notify:
    name: Notify Security Team
    runs-on: ubuntu-latest
    needs: [gitleaks, trivy-secrets, trufflehog, check-env-files]
    if: failure()
    steps:
      - name: Send notification
        run: |
          echo "üö® Secret detected in repository!"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Please review the security reports and take immediate action."

          # In production, send to Slack/Teams/Email
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"üö® Secret detected in UnifiedHealth Platform!"}'
