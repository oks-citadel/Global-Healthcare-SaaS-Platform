# =============================================================================
# ECS Fargate Deployment Pipeline
# =============================================================================
# This workflow deploys services to AWS ECS Fargate
# Replaces EKS/Kubernetes deployment workflow
# =============================================================================

name: ECS Deploy

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Target environment (dev, staging, production)'
      commit_sha:
        required: true
        type: string
        description: 'Git commit SHA for image tag'
      services:
        required: false
        type: string
        default: 'api,web-app'
        description: 'Comma-separated list of services to deploy'
    secrets:
      AWS_ROLE_ARN:
        required: true
      ECR_REGISTRY:
        required: true

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      services:
        description: 'Services to deploy (comma-separated)'
        required: false
        default: 'api,web-app'
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Deploy to ECS (${{ inputs.environment }})
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'production' && 'https://theunifiedhealth.com' || format('https://{0}.theunifiedhealth.com', inputs.environment) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set cluster name
        id: cluster
        run: |
          case "${{ inputs.environment }}" in
            dev)
              echo "name=unified-health-dev-cluster" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "name=unified-health-staging-cluster" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "name=unified-health-prod-cluster" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Deploy services to ECS
        id: deploy
        run: |
          CLUSTER="${{ steps.cluster.outputs.name }}"
          COMMIT_SHA="${{ inputs.commit_sha || github.sha }}"
          ECR_REGISTRY="${{ secrets.ECR_REGISTRY || steps.login-ecr.outputs.registry }}"
          SERVICES="${{ inputs.services }}"

          echo "Deploying to cluster: $CLUSTER"
          echo "Image tag: $COMMIT_SHA"
          echo "Services: $SERVICES"

          # Track deployed services
          DEPLOYED_SERVICES=""
          FAILED_SERVICES=""

          # Deploy each service
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for SERVICE in "${SERVICE_ARRAY[@]}"; do
            SERVICE=$(echo "$SERVICE" | xargs)  # Trim whitespace
            echo "----------------------------------------"
            echo "Deploying service: $SERVICE"

            # Get current task definition
            TASK_DEF=$(aws ecs describe-services \
              --cluster "$CLUSTER" \
              --services "$SERVICE" \
              --query 'services[0].taskDefinition' \
              --output text 2>/dev/null || echo "")

            if [ -z "$TASK_DEF" ] || [ "$TASK_DEF" == "None" ]; then
              echo "Service $SERVICE not found in cluster, skipping..."
              continue
            fi

            # Get task definition JSON
            TASK_DEF_JSON=$(aws ecs describe-task-definition \
              --task-definition "$TASK_DEF" \
              --query 'taskDefinition')

            # Update container image in task definition
            NEW_IMAGE="${ECR_REGISTRY}/unified-health-prod/${SERVICE}:${COMMIT_SHA}"
            echo "New image: $NEW_IMAGE"

            # Create new task definition with updated image
            NEW_TASK_DEF=$(echo "$TASK_DEF_JSON" | jq \
              --arg IMAGE "$NEW_IMAGE" \
              --arg SERVICE "$SERVICE" \
              '.containerDefinitions = [.containerDefinitions[] | if .name == $SERVICE then .image = $IMAGE else . end]' | \
              jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

            # Register new task definition
            NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
              --cli-input-json "$NEW_TASK_DEF" \
              --query 'taskDefinition.taskDefinitionArn' \
              --output text)

            echo "Registered new task definition: $NEW_TASK_DEF_ARN"

            # Update service with new task definition
            aws ecs update-service \
              --cluster "$CLUSTER" \
              --service "$SERVICE" \
              --task-definition "$NEW_TASK_DEF_ARN" \
              --force-new-deployment \
              --output text > /dev/null

            if [ $? -eq 0 ]; then
              echo "Successfully triggered deployment for $SERVICE"
              DEPLOYED_SERVICES="${DEPLOYED_SERVICES}${SERVICE},"
            else
              echo "Failed to deploy $SERVICE"
              FAILED_SERVICES="${FAILED_SERVICES}${SERVICE},"
            fi
          done

          echo "deployed_services=${DEPLOYED_SERVICES%,}" >> $GITHUB_OUTPUT
          echo "failed_services=${FAILED_SERVICES%,}" >> $GITHUB_OUTPUT

      - name: Wait for services to stabilize
        run: |
          CLUSTER="${{ steps.cluster.outputs.name }}"
          DEPLOYED="${{ steps.deploy.outputs.deployed_services }}"

          if [ -z "$DEPLOYED" ]; then
            echo "No services were deployed"
            exit 0
          fi

          echo "Waiting for services to stabilize: $DEPLOYED"

          # Convert comma-separated to space-separated for AWS CLI
          SERVICES_LIST=$(echo "$DEPLOYED" | tr ',' ' ')

          # Wait for deployment to complete (timeout: 10 minutes)
          aws ecs wait services-stable \
            --cluster "$CLUSTER" \
            --services $SERVICES_LIST \
            --region ${{ env.AWS_REGION }}

          if [ $? -eq 0 ]; then
            echo "All services are stable"
          else
            echo "Some services did not stabilize within timeout"
            exit 1
          fi

      - name: Verify deployment health
        run: |
          CLUSTER="${{ steps.cluster.outputs.name }}"
          DEPLOYED="${{ steps.deploy.outputs.deployed_services }}"

          if [ -z "$DEPLOYED" ]; then
            exit 0
          fi

          echo "Verifying service health..."

          IFS=',' read -ra SERVICE_ARRAY <<< "$DEPLOYED"
          for SERVICE in "${SERVICE_ARRAY[@]}"; do
            echo "Checking $SERVICE..."

            # Get running task count
            RUNNING=$(aws ecs describe-services \
              --cluster "$CLUSTER" \
              --services "$SERVICE" \
              --query 'services[0].runningCount' \
              --output text)

            DESIRED=$(aws ecs describe-services \
              --cluster "$CLUSTER" \
              --services "$SERVICE" \
              --query 'services[0].desiredCount' \
              --output text)

            echo "$SERVICE: $RUNNING/$DESIRED tasks running"

            if [ "$RUNNING" -lt "$DESIRED" ]; then
              echo "Warning: $SERVICE has fewer running tasks than desired"
            fi
          done

      - name: Deployment summary
        if: always()
        run: |
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Cluster: ${{ steps.cluster.outputs.name }}"
          echo "Commit: ${{ inputs.commit_sha || github.sha }}"
          echo "Deployed: ${{ steps.deploy.outputs.deployed_services }}"
          echo "Failed: ${{ steps.deploy.outputs.failed_services }}"
          echo "=========================================="

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback to previous task definition
        run: |
          CLUSTER="${{ needs.deploy.outputs.cluster_name || 'unified-health-prod-cluster' }}"
          SERVICES="${{ inputs.services }}"

          echo "Rolling back services in cluster: $CLUSTER"

          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for SERVICE in "${SERVICE_ARRAY[@]}"; do
            SERVICE=$(echo "$SERVICE" | xargs)
            echo "Rolling back $SERVICE..."

            # Get current task definition ARN
            CURRENT_TASK=$(aws ecs describe-services \
              --cluster "$CLUSTER" \
              --services "$SERVICE" \
              --query 'services[0].taskDefinition' \
              --output text 2>/dev/null || echo "")

            if [ -z "$CURRENT_TASK" ] || [ "$CURRENT_TASK" == "None" ]; then
              echo "Service $SERVICE not found, skipping rollback"
              continue
            fi

            # Get previous task definition (current revision - 1)
            FAMILY=$(echo "$CURRENT_TASK" | sed 's/:.*$//' | sed 's/.*\///')
            CURRENT_REV=$(echo "$CURRENT_TASK" | sed 's/.*://')
            PREV_REV=$((CURRENT_REV - 1))

            if [ $PREV_REV -lt 1 ]; then
              echo "No previous revision for $SERVICE"
              continue
            fi

            PREV_TASK="${FAMILY}:${PREV_REV}"
            echo "Rolling back from revision $CURRENT_REV to $PREV_REV"

            # Update service to previous task definition
            aws ecs update-service \
              --cluster "$CLUSTER" \
              --service "$SERVICE" \
              --task-definition "$PREV_TASK" \
              --force-new-deployment \
              --output text > /dev/null

            echo "Rollback triggered for $SERVICE"
          done

      - name: Wait for rollback to complete
        run: |
          CLUSTER="${{ needs.deploy.outputs.cluster_name || 'unified-health-prod-cluster' }}"
          SERVICES="${{ inputs.services }}"

          SERVICES_LIST=$(echo "$SERVICES" | tr ',' ' ')

          aws ecs wait services-stable \
            --cluster "$CLUSTER" \
            --services $SERVICES_LIST \
            --region ${{ env.AWS_REGION }} || true

          echo "Rollback complete"
