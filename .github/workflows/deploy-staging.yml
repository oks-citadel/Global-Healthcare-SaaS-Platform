# ============================================
# UnifiedHealth Platform - Deploy to Staging
# GitHub Actions for Staging Deployment on Azure
# All jobs run on GitHub-hosted runners with Azure Cloud
# ============================================
# WORKFLOW LOCKED - v1.0.0 deployed to production
# Automatic triggers disabled to prevent accidental deployments
# ============================================

name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY" to confirm manual trigger'
        required: true
        type: string
# DISABLED AUTOMATIC TRIGGERS - Uncomment to re-enable:
#  push:
#    branches:
#      - main

env:
  ACR_NAME: acrunifiedhealthdev2
  AKS_CLUSTER: unified-health-aks-staging
  RESOURCE_GROUP: rg-unified-health-dev2-staging
  NAMESPACE: unified-health-staging
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ==========================================
  # Build and Test
  # ==========================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

      - name: Run type check
        run: pnpm typecheck

      - name: Run tests
        run: pnpm test
        env:
          CI: true

      - name: Build services
        run: pnpm build

  # ==========================================
  # Build and Push Docker Images to Azure ACR
  # ==========================================
  build-and-push:
    name: Build and Push to Azure ACR
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: staging
    outputs:
      image_tag: ${{ steps.tags.outputs.IMAGE_TAG }}
      short_sha: ${{ steps.tags.outputs.SHORT_SHA }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set image tags
        id: tags
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG="${SHORT_SHA}-${TIMESTAMP}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./services/api
          file: ./services/api/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-api:${{ steps.tags.outputs.IMAGE_TAG }}
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-api:latest-staging
          cache-from: type=gha,scope=api-staging
          cache-to: type=gha,scope=api-staging,mode=max

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-web:${{ steps.tags.outputs.IMAGE_TAG }}
            ${{ env.ACR_NAME }}.azurecr.io/unified-health-web:latest-staging
          cache-from: type=gha,scope=web-staging
          cache-to: type=gha,scope=web-staging,mode=max

  # ==========================================
  # Deploy to Azure Kubernetes Service (Staging)
  # ==========================================
  deploy-to-aks:
    name: Deploy to Azure AKS
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER }} \
            --overwrite-existing

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Run database migrations
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: db-migration-${{ needs.build-and-push.outputs.short_sha }}
            namespace: ${{ env.NAMESPACE }}
          spec:
            ttlSecondsAfterFinished: 86400
            backoffLimit: 3
            template:
              spec:
                restartPolicy: Never
                containers:
                - name: migration
                  image: ${{ env.ACR_NAME }}.azurecr.io/unified-health-api:${{ needs.build-and-push.outputs.image_tag }}
                  command: ["pnpm", "db:migrate:deploy"]
                  env:
                  - name: DATABASE_URL
                    valueFrom:
                      secretKeyRef:
                        name: unified-health-secrets
                        key: database-url
          EOF

          kubectl wait --for=condition=complete \
            --timeout=300s \
            -n ${{ env.NAMESPACE }} \
            job/db-migration-${{ needs.build-and-push.outputs.short_sha }}

      - name: Deploy API to AKS
        run: |
          kubectl set image deployment/unified-health-api \
            api=${{ env.ACR_NAME }}.azurecr.io/unified-health-api:${{ needs.build-and-push.outputs.image_tag }} \
            -n ${{ env.NAMESPACE }} || \
          kubectl apply -f infrastructure/kubernetes/base/api-deployment.yaml -n ${{ env.NAMESPACE }}

      - name: Wait for API rollout
        run: |
          kubectl rollout status deployment/unified-health-api \
            -n ${{ env.NAMESPACE }} \
            --timeout=300s

      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=unified-health-api

          READY_PODS=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app=unified-health-api -o json | jq -r '.items[] | select(.status.phase=="Running") | .metadata.name' | wc -l)

          if [ "$READY_PODS" -eq 0 ]; then
            echo "No pods are running!"
            exit 1
          fi

          echo "Deployment successful: $READY_PODS pods running"

  # ==========================================
  # Run Smoke Tests on Azure
  # ==========================================
  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-to-aks
    environment: staging

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER }} \
            --overwrite-existing

      - name: Run health checks
        run: |
          # Get service endpoint
          API_ENDPOINT=$(kubectl get svc unified-health-api -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")

          if [ -z "$API_ENDPOINT" ]; then
            # Try port-forward if no LoadBalancer
            kubectl port-forward -n ${{ env.NAMESPACE }} svc/unified-health-api 8080:80 &
            PF_PID=$!
            sleep 10
            API_ENDPOINT="localhost:8080"
          fi

          # Test health endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${API_ENDPOINT}/health || echo "000")

          if [ "$HTTP_CODE" == "200" ]; then
            echo "Health check passed"
          else
            echo "Health check failed with code: $HTTP_CODE"
            [ ! -z "$PF_PID" ] && kill $PF_PID 2>/dev/null || true
            exit 1
          fi

          # Test ready endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${API_ENDPOINT}/ready || echo "000")

          if [ "$HTTP_CODE" == "200" ]; then
            echo "Ready check passed"
          else
            echo "Ready check failed with code: $HTTP_CODE"
            [ ! -z "$PF_PID" ] && kill $PF_PID 2>/dev/null || true
            exit 1
          fi

          [ ! -z "$PF_PID" ] && kill $PF_PID 2>/dev/null || true

  # ==========================================
  # Run E2E Tests on Azure
  # ==========================================
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps

      - name: Run E2E tests
        run: pnpm test:e2e
        env:
          E2E_BASE_URL: ${{ secrets.STAGING_URL }}
          E2E_API_URL: ${{ secrets.STAGING_API_URL }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/

  # ==========================================
  # Notify Deployment Status
  # ==========================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-to-aks, smoke-tests, e2e-tests]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy-to-aks.result }}" == "success" ] && [ "${{ needs.smoke-tests.result }}" == "success" ]; then
            echo "STATUS=SUCCESS" >> $GITHUB_OUTPUT
            echo "COLOR=good" >> $GITHUB_OUTPUT
          else
            echo "STATUS=FAILED" >> $GITHUB_OUTPUT
            echo "COLOR=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Staging Deployment ${{ steps.status.outputs.STATUS }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.COLOR }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "staging",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "${{ github.sha }}",
                      "short": true
                    },
                    {
                      "title": "Author",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Deployment Status",
                      "value": "${{ needs.deploy-to-aks.result }}",
                      "short": true
                    },
                    {
                      "title": "E2E Tests Status",
                      "value": "${{ needs.e2e-tests.result }}",
                      "short": true
                    }
                  ],
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Workflow",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
