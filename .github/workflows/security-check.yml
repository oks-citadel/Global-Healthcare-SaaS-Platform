# ============================================
# UnifiedHealth Platform - Security Check Pipeline
# PR-Gated Security Verification
# ============================================
# This workflow runs on every PR and blocks merge if security checks fail.
# It performs:
# 1. Dependency audit
# 2. SAST (Static Application Security Testing)
# 3. Business logic abuse tests
# 4. Security agent scan
# ============================================

name: Security Check

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened

  push:
    branches:
      - main
      - develop

  workflow_dispatch:

env:
  NODE_VERSION: "20"

jobs:
  # ==========================================
  # Dependency Security Audit
  # ==========================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: audit
        run: |
          pnpm audit --audit-level=moderate || echo "AUDIT_FAILED=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload audit results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: audit-results
          path: npm-audit.json
          if-no-files-found: ignore

      - name: Check audit status
        if: steps.audit.outputs.AUDIT_FAILED == 'true'
        run: |
          echo "::warning::Dependency vulnerabilities found. Review audit results."

  # ==========================================
  # Static Application Security Testing (SAST)
  # ==========================================
  sast:
    name: SAST Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/typescript
            p/nodejs
            p/secrets
            p/owasp-top-ten
          generateSarif: true
        continue-on-error: true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep
        continue-on-error: true

  # ==========================================
  # Secret Scanning
  # ==========================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

  # ==========================================
  # Custom Security Agent Scan
  # ==========================================
  security-agent:
    name: Security Agent Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security agent
        id: security-agent
        run: |
          npx ts-node tools/security-agent/scan.ts || echo "SECURITY_ISSUES=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: SECURITY/security-report.md

      - name: Comment on PR with findings
        if: github.event_name == 'pull_request' && steps.security-agent.outputs.SECURITY_ISSUES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = 'No report available';
            try {
              report = fs.readFileSync('SECURITY/security-report.md', 'utf8');
            } catch (e) {}

            const summary = report.split('## Summary')[1]?.split('## Status')[0] || 'Check the security report artifact.';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ”’ Security Scan Results\n\n${summary}\n\nâš ï¸ Please fix the issues before merging. See the uploaded artifact for the full report.`
            });

      - name: Fail if critical issues
        if: steps.security-agent.outputs.SECURITY_ISSUES == 'true'
        run: |
          echo "::error::Security issues found. Please review SECURITY/security-report.md"
          exit 1

  # ==========================================
  # Business Logic Abuse Tests
  # ==========================================
  abuse-tests:
    name: Business Logic Abuse Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build
        continue-on-error: true

      - name: Run abuse tests
        id: abuse-tests
        run: |
          cd services/api
          pnpm test -- tests/security/business-logic-abuse/ --reporter=verbose 2>&1 | tee abuse-test-results.txt
          RESULT=${PIPESTATUS[0]}
          if [ $RESULT -ne 0 ]; then
            echo "ABUSE_TESTS_FAILED=true" >> $GITHUB_OUTPUT
          fi
          exit $RESULT
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: abuse-test-results
          path: services/api/abuse-test-results.txt
          if-no-files-found: ignore

      - name: Fail if abuse tests failed
        if: steps.abuse-tests.outputs.ABUSE_TESTS_FAILED == 'true'
        run: |
          echo "::error::Business logic abuse tests failed. Review the test results."
          exit 1

  # ==========================================
  # Type Check and Lint
  # ==========================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm typecheck
        continue-on-error: true

      - name: Lint
        run: pnpm lint
        continue-on-error: true

  # ==========================================
  # Security Gate Summary
  # ==========================================
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs:
      - dependency-audit
      - sast
      - secret-scan
      - security-agent
      - abuse-tests
      - code-quality
    if: always()

    steps:
      - name: Check all security jobs
        run: |
          echo "Dependency Audit: ${{ needs.dependency-audit.result }}"
          echo "SAST: ${{ needs.sast.result }}"
          echo "Secret Scan: ${{ needs.secret-scan.result }}"
          echo "Security Agent: ${{ needs.security-agent.result }}"
          echo "Abuse Tests: ${{ needs.abuse-tests.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"

          # Critical checks that must pass
          if [ "${{ needs.security-agent.result }}" == "failure" ]; then
            echo "::error::Security Agent found critical issues. Merge blocked."
            exit 1
          fi

          if [ "${{ needs.abuse-tests.result }}" == "failure" ]; then
            echo "::error::Business logic abuse tests failed. Merge blocked."
            exit 1
          fi

          if [ "${{ needs.secret-scan.result }}" == "failure" ]; then
            echo "::error::Secrets detected in code. Merge blocked."
            exit 1
          fi

          echo "âœ… All security checks passed!"

      - name: Post summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'Dependency Audit': '${{ needs.dependency-audit.result }}',
              'SAST Analysis': '${{ needs.sast.result }}',
              'Secret Scanning': '${{ needs.secret-scan.result }}',
              'Security Agent': '${{ needs.security-agent.result }}',
              'Abuse Tests': '${{ needs.abuse-tests.result }}',
              'Code Quality': '${{ needs.code-quality.result }}'
            };

            let table = '| Check | Status |\n|-------|--------|\n';
            for (const [check, result] of Object.entries(results)) {
              const emoji = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'âš ï¸';
              table += `| ${check} | ${emoji} ${result} |\n`;
            }

            const allPassed = Object.values(results).every(r => r === 'success' || r === 'skipped');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ” Security Gate Results\n\n${table}\n\n${allPassed ? 'âœ… All checks passed!' : 'âš ï¸ Some checks need attention.'}`
            });
