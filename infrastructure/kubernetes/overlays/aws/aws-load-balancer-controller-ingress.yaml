# ============================================
# UnifiedHealth API - AWS ALB Ingress
# AWS Application Load Balancer Controller Ingress
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: unified-health-api-alb-ingress
  namespace: unified-health
  labels:
    app: unified-health-api
    component: ingress
    cloud-provider: aws
  annotations:
    # AWS ALB Ingress Controller annotations
    kubernetes.io/ingress.class: "alb"
    alb.ingress.kubernetes.io/scheme: "internet-facing"
    alb.ingress.kubernetes.io/target-type: "ip"

    # SSL/TLS Configuration
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}, {"HTTP":80}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    alb.ingress.kubernetes.io/certificate-arn: "${ACM_CERTIFICATE_ARN}"
    alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS13-1-2-2021-06"

    # Health Check Configuration
    alb.ingress.kubernetes.io/healthcheck-path: "/health"
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "3"

    # Load Balancer Configuration
    alb.ingress.kubernetes.io/load-balancer-attributes: >-
      idle_timeout.timeout_seconds=60,
      routing.http2.enabled=true,
      routing.http.drop_invalid_header_fields.enabled=true

    # WAF Integration (if you have AWS WAF configured)
    # alb.ingress.kubernetes.io/wafv2-acl-arn: "${WAF_ACL_ARN}"

    # Access Logging
    alb.ingress.kubernetes.io/load-balancer-attributes: >-
      access_logs.s3.enabled=true,
      access_logs.s3.bucket=${ALB_LOGS_BUCKET},
      access_logs.s3.prefix=unified-health-alb

    # Target Group Configuration
    alb.ingress.kubernetes.io/target-group-attributes: >-
      stickiness.enabled=true,
      stickiness.type=lb_cookie,
      stickiness.lb_cookie.duration_seconds=86400

    # Security Groups
    alb.ingress.kubernetes.io/security-groups: "${ALB_SECURITY_GROUP_IDS}"

    # Subnets
    alb.ingress.kubernetes.io/subnets: "${PUBLIC_SUBNET_IDS}"

    # Tags
    alb.ingress.kubernetes.io/tags: >-
      Environment=production,
      Application=unified-health,
      ManagedBy=kubernetes

    # External DNS Integration
    external-dns.alpha.kubernetes.io/hostname: "api.unifiedhealth.com"

spec:
  # Ingress Class (required for Kubernetes 1.18+)
  ingressClassName: alb

  # TLS Configuration
  tls:
    - hosts:
        - api.unifiedhealth.com
        - "*.unifiedhealth.com"

  # Routing Rules
  rules:
    - host: api.unifiedhealth.com
      http:
        paths:
          # API v1 routes
          - path: /api/v1
            pathType: Prefix
            backend:
              service:
                name: unified-health-api
                port:
                  number: 80

          # Health check endpoint
          - path: /health
            pathType: Exact
            backend:
              service:
                name: unified-health-api
                port:
                  number: 80

          # Readiness check endpoint
          - path: /ready
            pathType: Exact
            backend:
              service:
                name: unified-health-api
                port:
                  number: 80

---
# ============================================
# Internal ALB Ingress for private services
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: unified-health-api-internal-alb
  namespace: unified-health
  labels:
    app: unified-health-api
    component: ingress
    cloud-provider: aws
    scope: internal
  annotations:
    kubernetes.io/ingress.class: "alb"
    alb.ingress.kubernetes.io/scheme: "internal"
    alb.ingress.kubernetes.io/target-type: "ip"

    # SSL Configuration
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
    alb.ingress.kubernetes.io/certificate-arn: "${ACM_CERTIFICATE_ARN}"

    # Health Check
    alb.ingress.kubernetes.io/healthcheck-path: "/health"

    # Internal subnets
    alb.ingress.kubernetes.io/subnets: "${PRIVATE_SUBNET_IDS}"

    # Security Groups for internal traffic
    alb.ingress.kubernetes.io/security-groups: "${INTERNAL_ALB_SECURITY_GROUP_IDS}"

spec:
  ingressClassName: alb
  rules:
    - host: api-internal.unifiedhealth.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: unified-health-api
                port:
                  number: 80
