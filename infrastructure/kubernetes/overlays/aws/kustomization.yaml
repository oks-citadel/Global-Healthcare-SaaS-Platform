# ============================================
# The Unified Health API - AWS EKS Overlay
# AWS-specific configurations for EKS deployment
# ============================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Reference to base configuration
resources:
  - ../../base
  - namespace.yaml
  - aws-load-balancer-controller-ingress.yaml

# Namespace for AWS deployment
namespace: unified-health

# Common labels for AWS
commonLabels:
  cloud-provider: aws
  platform: eks
  environment: production

# Common annotations for AWS
commonAnnotations:
  cloud-provider: aws
  managed-by: kustomize
  deployment-platform: eks

# AWS-specific replicas
replicas:
  - name: unified-health-api
    count: 3

# AWS ECR images
images:
  - name: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/unifiedhealth/api-gateway
    newTag: latest
  - name: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/unifiedhealth/telehealth-service
    newTag: latest
  - name: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/unifiedhealth/mental-health-service
    newTag: latest
  - name: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/unifiedhealth/chronic-care-service
    newTag: latest
  - name: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/unifiedhealth/pharmacy-service
    newTag: latest
  - name: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/unifiedhealth/laboratory-service
    newTag: latest
  - name: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/unifiedhealth/web
    newTag: latest

# Patches for AWS-specific configurations
patches:
  # Patch Service Account for AWS IRSA
  - target:
      kind: ServiceAccount
      name: unified-health-api
    patch: |-
      - op: replace
        path: /metadata/annotations/eks.amazonaws.com~1role-arn
        value: "${AWS_IAM_ROLE_ARN}"

  # Patch Deployment for AWS-specific settings
  - target:
      kind: Deployment
      name: unified-health-api
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: AWS_REGION
          value: "${AWS_REGION}"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUD_PROVIDER
          value: "aws"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: AWS_DEFAULT_REGION
          value: "${AWS_REGION}"

  # Patch ConfigMap for AWS-specific database settings
  - target:
      kind: ConfigMap
      name: unified-health-config
    patch: |-
      - op: replace
        path: /data/database-host
        value: "${RDS_ENDPOINT}"
      - op: add
        path: /data/cloud-provider
        value: "aws"
      - op: add
        path: /data/s3-bucket
        value: "${S3_BUCKET_NAME}"
      - op: add
        path: /data/aws-region
        value: "${AWS_REGION}"

# ConfigMap generator for AWS-specific config
configMapGenerator:
  - name: aws-config
    literals:
      - CLOUD_PROVIDER=aws
      - AWS_REGION=${AWS_REGION}
      - ECR_REGISTRY=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
      - S3_BUCKET=${S3_BUCKET_NAME}
      - RDS_ENDPOINT=${RDS_ENDPOINT}
      - ELASTICACHE_ENDPOINT=${ELASTICACHE_ENDPOINT}

# Secret generator for AWS
secretGenerator:
  - name: aws-secrets
    type: Opaque
    literals: []
