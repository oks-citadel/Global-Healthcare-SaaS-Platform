---
# ============================================
# ExternalSecret - HIPAA Compliance Secrets
# ============================================
# Syncs PHI/PII encryption keys and HIPAA-related secrets
# These secrets require additional access controls and audit logging
#
# AWS Secret Structure (unified-health/hipaa):
# {
#   "phi_encryption_key": "your-phi-encryption-key-256-bits",
#   "data_encryption_key": "your-data-encryption-key-256-bits",
#   "audit_encryption_key": "your-audit-encryption-key-256-bits",
#   "backup_encryption_key": "your-backup-encryption-key-256-bits"
# }
#
# IMPORTANT: These secrets must be:
# - Stored with KMS encryption in AWS Secrets Manager
# - Access logged via CloudTrail
# - Rotated according to HIPAA policies
# ============================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: hipaa-secrets
  namespace: unified-health
  labels:
    app.kubernetes.io/name: hipaa-secrets
    app.kubernetes.io/component: external-secret
    compliance: hipaa
spec:
  # More frequent refresh for compliance secrets
  refreshInterval: 30m

  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: hipaa-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app: unified-health
          component: security
          compliance: hipaa
        annotations:
          compliance.unified-health.io/type: hipaa
          compliance.unified-health.io/encrypted: "true"
      data:
        PHI_ENCRYPTION_KEY: "{{ .phi_encryption_key }}"
        DATA_ENCRYPTION_KEY: "{{ .data_encryption_key }}"
        AUDIT_ENCRYPTION_KEY: "{{ .audit_encryption_key }}"
        BACKUP_ENCRYPTION_KEY: "{{ .backup_encryption_key }}"

  data:
    - secretKey: phi_encryption_key
      remoteRef:
        key: unified-health/hipaa
        property: phi_encryption_key
    - secretKey: data_encryption_key
      remoteRef:
        key: unified-health/hipaa
        property: data_encryption_key
    - secretKey: audit_encryption_key
      remoteRef:
        key: unified-health/hipaa
        property: audit_encryption_key
    - secretKey: backup_encryption_key
      remoteRef:
        key: unified-health/hipaa
        property: backup_encryption_key
