---
# ============================================
# ClusterSecretStore - AWS Secrets Manager
# ============================================
# Connects External Secrets Operator to AWS Secrets Manager
# This is a cluster-wide resource that can be used by ExternalSecrets in any namespace
#
# Prerequisites:
# 1. External Secrets Operator installed (helm install external-secrets external-secrets/external-secrets)
# 2. IRSA (IAM Roles for Service Accounts) configured with Secrets Manager access
# 3. AWS region configured correctly
#
# Documentation: https://external-secrets.io/latest/provider/aws-secrets-manager/
# ============================================
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
spec:
  provider:
    aws:
      service: SecretsManager
      # Region where secrets are stored
      region: us-east-1
      # Use IRSA (IAM Roles for Service Accounts) for authentication
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets
---
# ============================================
# ClusterSecretStore - AWS Parameter Store
# ============================================
# Alternative store for non-sensitive configuration values
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-parameter-store
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
spec:
  provider:
    aws:
      service: ParameterStore
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets
---
# ============================================
# ServiceAccount for External Secrets
# ============================================
# This ServiceAccount uses IRSA to assume an IAM role with Secrets Manager access
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: external-secrets
  annotations:
    # IAM Role ARN is injected via Kustomize overlay or Helm values
    # In production, this is set by: kustomize edit set annotation eks.amazonaws.com/role-arn=<ARN>
    # Or via Helm: --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=<ARN>
    eks.amazonaws.com/role-arn: "${AWS_ACCOUNT_ID_PLACEHOLDER:=arn:aws:iam::992382449461:role/unified-health-external-secrets-role}"
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: service-account
