# ============================================
# DNS-01 ClusterIssuer for AWS Route53
# ============================================
# This configuration uses AWS Route53 with IAM credentials
# for DNS-01 ACME challenges (alternative approach)
#
# Use this if IRSA (IAM Roles for Service Accounts) is not available
# or for environments that require explicit IAM credentials.
#
# Prerequisites:
# 1. Route53 hosted zone exists in your AWS account
# 2. IAM user with Route53 permissions
# 3. Kubernetes secret with IAM credentials
# ============================================

---
# Secret for IAM credentials
# IMPORTANT: Create this secret before applying the ClusterIssuer
# kubectl create secret generic aws-route53-credentials \
#   --namespace cert-manager \
#   --from-literal=access-key-id="YOUR_ACCESS_KEY_ID" \
#   --from-literal=secret-access-key="YOUR_SECRET_ACCESS_KEY"
apiVersion: v1
kind: Secret
metadata:
  name: aws-route53-credentials
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: aws-credentials
    app.kubernetes.io/part-of: unified-health
type: Opaque
stringData:
  # IMPORTANT: Replace with actual IAM credentials
  # In production, use kubectl create secret or external secrets operator
  access-key-id: "REPLACE_WITH_AWS_ACCESS_KEY_ID"
  secret-access-key: "REPLACE_WITH_AWS_SECRET_ACCESS_KEY"

---
# Production ClusterIssuer with Route53 (IAM credentials)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod-dns01-iam
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cluster-issuer
    app.kubernetes.io/part-of: unified-health
spec:
  acme:
    # Production Let's Encrypt server
    server: https://acme-v02.api.letsencrypt.org/directory

    # Email for certificate expiration notifications
    email: platform-admin@unifiedhealth.com

    # Secret to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod-dns01-iam-account-key

    solvers:
    # DNS-01 solver using Route53 with IAM credentials
    - dns01:
        route53:
          # AWS region for Route53
          region: us-east-1

          # Route53 hosted zone ID
          # IMPORTANT: Replace with your actual hosted zone ID
          hostedZoneID: "YOUR_HOSTED_ZONE_ID"

          # Reference to secret containing IAM credentials
          accessKeyIDSecretRef:
            name: aws-route53-credentials
            key: access-key-id
          secretAccessKeySecretRef:
            name: aws-route53-credentials
            key: secret-access-key

---
# Staging ClusterIssuer for testing (IAM credentials)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging-dns01-iam
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cluster-issuer
    app.kubernetes.io/part-of: unified-health
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: platform-admin@unifiedhealth.com
    privateKeySecretRef:
      name: letsencrypt-staging-dns01-iam-account-key

    solvers:
    - dns01:
        route53:
          region: us-east-1
          hostedZoneID: "YOUR_HOSTED_ZONE_ID"
          accessKeyIDSecretRef:
            name: aws-route53-credentials
            key: access-key-id
          secretAccessKeySecretRef:
            name: aws-route53-credentials
            key: secret-access-key
