# ============================================
# DNS-01 ClusterIssuer for Azure DNS
# ============================================
# This configuration uses Azure DNS with Service Principal
# for DNS-01 ACME challenges (alternative approach)
#
# Use this if Workload Identity is not available or
# for environments that require explicit credentials.
#
# Prerequisites:
# 1. Azure DNS Zone exists in your subscription
# 2. Service Principal with DNS Zone Contributor role
# 3. Kubernetes secret with SP credentials
# ============================================

---
# Secret for Service Principal credentials
# IMPORTANT: Create this secret before applying the ClusterIssuer
# kubectl create secret generic azure-dns-sp-secret \
#   --namespace cert-manager \
#   --from-literal=client-secret="YOUR_SP_PASSWORD"
apiVersion: v1
kind: Secret
metadata:
  name: azure-dns-sp-secret
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: azure-credentials
    app.kubernetes.io/part-of: unified-health
type: Opaque
stringData:
  # IMPORTANT: Replace with actual service principal password
  # In production, use kubectl create secret or external secrets operator
  client-secret: "REPLACE_WITH_SP_CLIENT_SECRET"

---
# Production ClusterIssuer with Azure DNS (Service Principal)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod-dns01-sp
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cluster-issuer
    app.kubernetes.io/part-of: unified-health
spec:
  acme:
    # Production Let's Encrypt server
    server: https://acme-v02.api.letsencrypt.org/directory

    # Email for certificate expiration notifications
    email: platform-admin@unifiedhealth.com

    # Secret to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod-dns01-sp-account-key

    solvers:
    # DNS-01 solver using Azure DNS with Service Principal
    - dns01:
        azureDNS:
          # Service Principal Application (Client) ID
          # IMPORTANT: Replace with your actual SP client ID
          clientID: "YOUR_SERVICE_PRINCIPAL_CLIENT_ID"

          # Reference to the secret containing SP password
          clientSecretSecretRef:
            name: azure-dns-sp-secret
            key: client-secret

          # Azure subscription containing the DNS zone
          subscriptionID: "YOUR_AZURE_SUBSCRIPTION_ID"

          # Azure AD tenant ID
          tenantID: "YOUR_AZURE_TENANT_ID"

          # Resource group containing the DNS zone
          resourceGroupName: "rg-unified-health-dns"

          # The Azure DNS zone name
          hostedZoneName: "unifiedhealth.com"

          # Azure cloud environment
          environment: AzurePublicCloud

---
# Staging ClusterIssuer for testing (Service Principal)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging-dns01-sp
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cluster-issuer
    app.kubernetes.io/part-of: unified-health
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: platform-admin@unifiedhealth.com
    privateKeySecretRef:
      name: letsencrypt-staging-dns01-sp-account-key

    solvers:
    - dns01:
        azureDNS:
          clientID: "YOUR_SERVICE_PRINCIPAL_CLIENT_ID"
          clientSecretSecretRef:
            name: azure-dns-sp-secret
            key: client-secret
          subscriptionID: "YOUR_AZURE_SUBSCRIPTION_ID"
          tenantID: "YOUR_AZURE_TENANT_ID"
          resourceGroupName: "rg-unified-health-dns"
          hostedZoneName: "unifiedhealth.com"
          environment: AzurePublicCloud
