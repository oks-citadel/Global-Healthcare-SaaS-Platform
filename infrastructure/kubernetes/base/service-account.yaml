---
# ============================================
# UnifiedHealth API - Service Account
# With AWS IAM Roles for Service Accounts (IRSA)
# ============================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: unified-health-api
  namespace: unified-health
  labels:
    app: unified-health-api
    component: identity
  annotations:
    # AWS IRSA annotations
    eks.amazonaws.com/role-arn: "${AWS_IAM_ROLE_ARN}"
    eks.amazonaws.com/sts-regional-endpoints: "true"

    # Description
    description: "Service account for UnifiedHealth API with AWS IRSA"

automountServiceAccountToken: true

---
# ============================================
# UnifiedHealth API - Role
# Define permissions for the service account
# ============================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: unified-health-api-role
  namespace: unified-health
  labels:
    app: unified-health-api
    component: rbac
rules:
  # Allow reading ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Allow reading Secrets
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]

  # Allow reading Services
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list"]

  # Allow reading Endpoints
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch"]

  # Allow reading Pods (for service discovery)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

  # Allow creating Events (for logging)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

---
# ============================================
# UnifiedHealth API - RoleBinding
# Bind the role to the service account
# ============================================
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: unified-health-api-rolebinding
  namespace: unified-health
  labels:
    app: unified-health-api
    component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: unified-health-api-role
subjects:
  - kind: ServiceAccount
    name: unified-health-api
    namespace: unified-health

---
# ============================================
# UnifiedHealth API - ClusterRole
# Cluster-wide permissions (if needed)
# ============================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: unified-health-api-clusterrole
  labels:
    app: unified-health-api
    component: rbac
rules:
  # Allow reading nodes (for cluster awareness)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]

  # Allow reading namespaces
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]

---
# ============================================
# UnifiedHealth API - ClusterRoleBinding
# Bind the cluster role to the service account
# ============================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: unified-health-api-clusterrolebinding
  labels:
    app: unified-health-api
    component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: unified-health-api-clusterrole
subjects:
  - kind: ServiceAccount
    name: unified-health-api
    namespace: unified-health

---
# ============================================
# AWS IRSA (IAM Roles for Service Accounts) Setup Instructions
# ============================================
#
# 1. Create IAM OIDC Provider for EKS cluster
#    eksctl utils associate-iam-oidc-provider \
#      --cluster unified-health-eks \
#      --approve
#
# 2. Create IAM Policy for the service account
#    aws iam create-policy \
#      --policy-name unified-health-api-policy \
#      --policy-document file://iam-policy.json
#
#    iam-policy.json example:
#    {
#      "Version": "2012-10-17",
#      "Statement": [
#        {
#          "Effect": "Allow",
#          "Action": [
#            "secretsmanager:GetSecretValue",
#            "secretsmanager:DescribeSecret"
#          ],
#          "Resource": "arn:aws:secretsmanager:*:*:secret:unified-health/*"
#        },
#        {
#          "Effect": "Allow",
#          "Action": [
#            "s3:GetObject",
#            "s3:PutObject",
#            "s3:DeleteObject",
#            "s3:ListBucket"
#          ],
#          "Resource": [
#            "arn:aws:s3:::unified-health-*",
#            "arn:aws:s3:::unified-health-*/*"
#          ]
#        }
#      ]
#    }
#
# 3. Create IAM Role with trust policy for the service account
#    eksctl create iamserviceaccount \
#      --name unified-health-api \
#      --namespace unified-health \
#      --cluster unified-health-eks \
#      --attach-policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/unified-health-api-policy \
#      --approve \
#      --override-existing-serviceaccounts
#
# 4. Verify the service account
#    kubectl describe sa unified-health-api -n unified-health
#
# ============================================
