---
# ============================================
# UnifiedHealth API - Service Account
# With Azure Workload Identity integration
# ============================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: unified-health-api
  namespace: unified-health
  labels:
    app: unified-health-api
    component: identity
  annotations:
    # Azure Workload Identity annotations
    azure.workload.identity/client-id: "${AZURE_CLIENT_ID}"
    azure.workload.identity/tenant-id: "${AZURE_TENANT_ID}"
    azure.workload.identity/service-account-token-expiration: "3600"

    # Azure Key Vault integration
    azure.workload.identity/use: "true"

    # Description
    description: "Service account for UnifiedHealth API with Azure Workload Identity"

automountServiceAccountToken: true

---
# ============================================
# UnifiedHealth API - Role
# Define permissions for the service account
# ============================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: unified-health-api-role
  namespace: unified-health
  labels:
    app: unified-health-api
    component: rbac
rules:
  # Allow reading ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Allow reading Secrets
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]

  # Allow reading Services
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list"]

  # Allow reading Endpoints
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch"]

  # Allow reading Pods (for service discovery)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

  # Allow creating Events (for logging)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

---
# ============================================
# UnifiedHealth API - RoleBinding
# Bind the role to the service account
# ============================================
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: unified-health-api-rolebinding
  namespace: unified-health
  labels:
    app: unified-health-api
    component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: unified-health-api-role
subjects:
  - kind: ServiceAccount
    name: unified-health-api
    namespace: unified-health

---
# ============================================
# UnifiedHealth API - ClusterRole
# Cluster-wide permissions (if needed)
# ============================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: unified-health-api-clusterrole
  labels:
    app: unified-health-api
    component: rbac
rules:
  # Allow reading nodes (for cluster awareness)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]

  # Allow reading namespaces
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]

---
# ============================================
# UnifiedHealth API - ClusterRoleBinding
# Bind the cluster role to the service account
# ============================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: unified-health-api-clusterrolebinding
  labels:
    app: unified-health-api
    component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: unified-health-api-clusterrole
subjects:
  - kind: ServiceAccount
    name: unified-health-api
    namespace: unified-health

---
# ============================================
# Azure Workload Identity Setup Instructions
# ============================================
#
# 1. Create Azure AD Application
#    az ad app create --display-name "unified-health-api"
#
# 2. Create Service Principal
#    az ad sp create --id <APPLICATION_ID>
#
# 3. Create Federated Identity Credential
#    az ad app federated-credential create \
#      --id <APPLICATION_ID> \
#      --parameters @federated-identity.json
#
#    federated-identity.json:
#    {
#      "name": "unified-health-api-federated-identity",
#      "issuer": "https://oidc.prod-aks.azure.com/<TENANT_ID>/",
#      "subject": "system:serviceaccount:unified-health:unified-health-api",
#      "description": "Federated identity for UnifiedHealth API",
#      "audiences": [
#        "api://AzureADTokenExchange"
#      ]
#    }
#
# 4. Grant Azure RBAC permissions
#    # Key Vault access
#    az role assignment create \
#      --role "Key Vault Secrets User" \
#      --assignee <SERVICE_PRINCIPAL_ID> \
#      --scope /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RG_NAME>/providers/Microsoft.KeyVault/vaults/<KV_NAME>
#
#    # Storage account access
#    az role assignment create \
#      --role "Storage Blob Data Contributor" \
#      --assignee <SERVICE_PRINCIPAL_ID> \
#      --scope /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RG_NAME>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT>
#
# 5. Install Azure Workload Identity webhook
#    helm repo add azure-workload-identity https://azure.github.io/azure-workload-identity/charts
#    helm install workload-identity-webhook azure-workload-identity/workload-identity-webhook \
#      --namespace azure-workload-identity-system \
#      --create-namespace
#
# 6. Update deployment annotations
#    The deployment should include:
#    metadata:
#      labels:
#        azure.workload.identity/use: "true"
#
# ============================================
