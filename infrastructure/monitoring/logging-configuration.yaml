---
# ============================================
# Centralized Logging Configuration
# Unified Healthcare Platform
# ============================================

apiVersion: logging.unified-health.io/v1
kind: LoggingConfiguration
metadata:
  name: unified-health-logging
  version: "1.0"

# ==========================================
# Log Format Standardization
# ==========================================
logFormat:
  # Standard JSON structured logging format
  standard:
    format: "json"
    timestamp:
      field: "timestamp"
      format: "ISO8601"
      timezone: "UTC"

    # Required fields for all log entries
    requiredFields:
      - timestamp
      - level
      - service
      - environment
      - correlationId
      - message

    # Standard log levels
    levels:
      - TRACE
      - DEBUG
      - INFO
      - WARN
      - ERROR
      - FATAL

    # Field naming conventions
    fieldNaming:
      convention: "camelCase"
      reservedFields:
        - timestamp
        - level
        - service
        - environment
        - correlationId
        - traceId
        - spanId
        - userId
        - sessionId
        - requestId
        - message
        - error
        - stack
        - metadata

  # Log entry structure template
  template:
    timestamp: "2025-12-17T10:30:45.123Z"
    level: "INFO"
    service: "unified-health-api"
    environment: "production"
    component: "appointment-service"
    correlationId: "req-123e4567-e89b-12d3-a456-426614174000"
    traceId: "trace-123e4567-e89b-12d3-a456-426614174000"
    spanId: "span-123e4567"
    userId: "user-789"
    sessionId: "session-456"
    requestId: "req-123"
    method: "POST"
    path: "/api/v1/appointments"
    statusCode: 201
    duration: 245
    ip: "192.168.1.1"
    userAgent: "Mozilla/5.0..."
    message: "Appointment created successfully"
    metadata:
      appointmentId: "appt-123"
      patientId: "patient-456"
      providerId: "provider-789"
    error:
      type: "ValidationError"
      message: "Invalid appointment date"
      stack: "Error stack trace..."
      code: "INVALID_DATE"

# ==========================================
# Log Aggregation Setup
# ==========================================
aggregation:

  # Azure Log Analytics Configuration
  azureLogAnalytics:
    enabled: true
    workspaceId: "${AZURE_LOG_ANALYTICS_WORKSPACE_ID}"
    workspaceKey: "${AZURE_LOG_ANALYTICS_KEY}"
    logType: "UnifiedHealthLogs"

    # Data collection endpoints
    dataCollectionEndpoint: "https://unified-health-logs.eastus-1.ingest.monitor.azure.com"

    # Custom tables
    customTables:
      - name: "ApplicationLogs_CL"
        columns:
          - name: "TimeGenerated"
            type: "datetime"
          - name: "Service"
            type: "string"
          - name: "Level"
            type: "string"
          - name: "Message"
            type: "string"
          - name: "CorrelationId"
            type: "string"
          - name: "UserId"
            type: "string"
          - name: "Environment"
            type: "string"
          - name: "Component"
            type: "string"
          - name: "Metadata"
            type: "dynamic"

      - name: "AuditLogs_CL"
        columns:
          - name: "TimeGenerated"
            type: "datetime"
          - name: "Action"
            type: "string"
          - name: "Actor"
            type: "string"
          - name: "Resource"
            type: "string"
          - name: "ResourceId"
            type: "string"
          - name: "Result"
            type: "string"
          - name: "IPAddress"
            type: "string"
          - name: "Details"
            type: "dynamic"

      - name: "SecurityLogs_CL"
        columns:
          - name: "TimeGenerated"
            type: "datetime"
          - name: "EventType"
            type: "string"
          - name: "Severity"
            type: "string"
          - name: "Source"
            type: "string"
          - name: "Target"
            type: "string"
          - name: "Details"
            type: "dynamic"

      - name: "PerformanceLogs_CL"
        columns:
          - name: "TimeGenerated"
            type: "datetime"
          - name: "Metric"
            type: "string"
          - name: "Value"
            type: "real"
          - name: "Unit"
            type: "string"
          - name: "Service"
            type: "string"
          - name: "Tags"
            type: "dynamic"

    # Batch configuration
    batchSize: 1000
    batchInterval: 30 # seconds
    maxRetries: 3
    retryDelay: 5 # seconds

  # Application Insights Integration
  applicationInsights:
    enabled: true
    instrumentationKey: "${AZURE_APPINSIGHTS_INSTRUMENTATION_KEY}"
    connectionString: "${AZURE_APPINSIGHTS_CONNECTION_STRING}"

    # Telemetry types
    telemetryTypes:
      - traces
      - requests
      - dependencies
      - exceptions
      - events
      - metrics
      - pageViews

    # Sampling configuration
    sampling:
      enabled: true
      percentage: 100 # 100% in production, can be reduced if needed
      excludeTypes: []

    # Correlation tracking
    correlation:
      enabled: true
      operationIdHeader: "x-correlation-id"
      operationNameHeader: "x-operation-name"

  # Fluentd/Fluent Bit Configuration
  fluentd:
    enabled: true
    type: "fluent-bit"

    inputs:
      - name: "tail"
        path: "/var/log/containers/*.log"
        parser: "docker"
        tag: "kube.*"
        refreshInterval: 5
        memBufLimit: "5MB"

      - name: "systemd"
        tag: "systemd.*"
        readFromTail: true
        stripUnderscores: true

    filters:
      - name: "kubernetes"
        match: "kube.*"
        kubeURL: "https://kubernetes.default.svc:443"
        kubeCAFile: "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
        kubeTokenFile: "/var/run/secrets/kubernetes.io/serviceaccount/token"
        mergeLog: true
        keepLog: false
        k8sLoggingParser: true
        k8sLoggingExclude: true

      - name: "parser"
        match: "kube.*"
        keyName: "log"
        parser: "json"
        reserveData: true

      - name: "modify"
        match: "*"
        operations:
          - add:
              environment: "production"
              cluster: "unified-health-prod"

    outputs:
      - name: "azure"
        match: "*"
        customerID: "${AZURE_LOG_ANALYTICS_WORKSPACE_ID}"
        sharedKey: "${AZURE_LOG_ANALYTICS_KEY}"
        logType: "FluentBitLogs"

      - name: "azure_blob"
        match: "*"
        accountName: "${AZURE_STORAGE_ACCOUNT}"
        sharedKey: "${AZURE_STORAGE_KEY}"
        container: "unified-health-logs"
        autoCreateContainer: true
        path: "logs/%Y/%m/%d"
        timeKey: "timestamp"
        format: "json"

# ==========================================
# Log Retention Policies
# ==========================================
retention:

  # Default retention policy
  default:
    duration: 90 # days
    autoDelete: true

  # Service-specific retention
  services:
    - name: "unified-health-api"
      retention: 90 # days
      archiveAfter: 30 # days
      archiveLocation: "azure-blob-storage"

    - name: "unified-health-web"
      retention: 60 # days
      archiveAfter: 30 # days

    - name: "unified-health-mobile"
      retention: 60 # days
      archiveAfter: 30 # days

  # Log type specific retention
  logTypes:
    - type: "audit"
      retention: 2555 # 7 years for compliance (HIPAA requirement)
      immutable: true
      archiveAfter: 90 # days
      archiveLocation: "azure-blob-storage-immutable"
      compressionEnabled: true

    - type: "security"
      retention: 365 # 1 year
      archiveAfter: 90 # days
      immutable: true

    - type: "application"
      retention: 90 # days
      archiveAfter: 30 # days

    - type: "performance"
      retention: 30 # days
      archiveAfter: 7 # days
      aggregateAfter: 24 # hours

    - type: "debug"
      retention: 7 # days
      autoDelete: true
      environments:
        - development
        - staging

  # Archive configuration
  archive:
    enabled: true
    storageAccount: "${AZURE_ARCHIVE_STORAGE_ACCOUNT}"
    container: "unified-health-logs-archive"
    compression: "gzip"
    encryption: "AES-256"
    accessTier: "Cool" # Hot, Cool, Archive

    # Archive lifecycle management
    lifecycle:
      - name: "move-to-cool"
        daysAfterModification: 30
        action: "moveToAccessTier"
        tier: "Cool"

      - name: "move-to-archive"
        daysAfterModification: 90
        action: "moveToAccessTier"
        tier: "Archive"

      - name: "delete-old-logs"
        daysAfterModification: 2555 # 7 years
        action: "delete"
        excludeTypes:
          - audit
          - security

# ==========================================
# Log Enrichment
# ==========================================
enrichment:

  # Automatic field enrichment
  autoEnrich:
    enabled: true
    fields:
      - name: "kubernetes"
        source: "metadata"
        fields:
          - podName
          - namespace
          - containerName
          - nodeName
          - labels

      - name: "cloud"
        fields:
          - provider: "azure"
          - region: "${AZURE_REGION}"
          - subscriptionId: "${AZURE_SUBSCRIPTION_ID}"

      - name: "application"
        fields:
          - version: "${APP_VERSION}"
          - build: "${BUILD_NUMBER}"
          - gitCommit: "${GIT_COMMIT}"

  # GeoIP enrichment for request logs
  geoip:
    enabled: true
    database: "GeoLite2-City"
    sourceField: "ip"
    targetFields:
      - country
      - city
      - latitude
      - longitude
      - timezone

# ==========================================
# Log Sampling & Throttling
# ==========================================
sampling:

  # Debug log sampling
  debug:
    enabled: true
    rate: 0.1 # 10% of debug logs
    environments:
      - production

  # Trace log sampling
  trace:
    enabled: true
    rate: 0.01 # 1% of trace logs
    environments:
      - production

  # High-volume endpoint sampling
  endpoints:
    - path: "/api/v1/health"
      sampleRate: 0.1 # 10% of health check logs

    - path: "/api/v1/metrics"
      sampleRate: 0.1

  # Rate limiting per service
  rateLimiting:
    enabled: true
    maxLogsPerSecond: 1000
    burstSize: 2000
    strategy: "token-bucket"

# ==========================================
# Sensitive Data Masking
# ==========================================
dataMasking:

  enabled: true

  # PII/PHI patterns to mask
  patterns:
    - name: "email"
      regex: '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
      replacement: "***EMAIL***"

    - name: "ssn"
      regex: '\b\d{3}-\d{2}-\d{4}\b'
      replacement: "***SSN***"

    - name: "phone"
      regex: '\b\d{3}[-.]?\d{3}[-.]?\d{4}\b'
      replacement: "***PHONE***"

    - name: "creditCard"
      regex: '\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b'
      replacement: "***CARD***"

    - name: "ipAddress"
      regex: '\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b'
      replacement: "***IP***"
      excludePaths:
        - "/api/v1/admin/security"

    - name: "jwt"
      regex: 'eyJ[A-Za-z0-9-_=]+\.eyJ[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*'
      replacement: "***JWT***"

  # Fields to always mask
  fields:
    - password
    - token
    - secret
    - apiKey
    - privateKey
    - authorization

# ==========================================
# Log Routing
# ==========================================
routing:

  # Route logs based on level
  byLevel:
    ERROR:
      destinations:
        - azureLogAnalytics
        - applicationInsights
        - alertingSystem

    FATAL:
      destinations:
        - azureLogAnalytics
        - applicationInsights
        - alertingSystem
        - pagerDuty

    WARN:
      destinations:
        - azureLogAnalytics
        - applicationInsights

    INFO:
      destinations:
        - azureLogAnalytics

    DEBUG:
      destinations:
        - azureLogAnalytics
      environments:
        - development
        - staging

  # Route logs based on type
  byType:
    audit:
      destinations:
        - azureLogAnalytics
        - immutableStorage
        - siemSystem

    security:
      destinations:
        - azureLogAnalytics
        - securityCenter
        - siemSystem

    performance:
      destinations:
        - applicationInsights
        - metricsAggregator

# ==========================================
# Performance Optimization
# ==========================================
performance:

  # Buffering configuration
  buffering:
    enabled: true
    maxSize: 10485760 # 10MB
    flushInterval: 30 # seconds
    flushOnShutdown: true

  # Compression
  compression:
    enabled: true
    algorithm: "gzip"
    level: 6 # 1-9, higher = more compression

  # Async logging
  async:
    enabled: true
    queueSize: 10000
    workers: 4
    dropOnOverflow: false
