# ============================================
# UnifiedHealth Web Frontend - Production Deployment
# Compliant with zero-downtime deployment requirements
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
  namespace: unifiedhealth-production
  labels:
    app: web
    environment: production
    tier: frontend
spec:
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: web
  strategy:
    type: RollingUpdate
    rollingUpdate:
      # Zero-downtime: Never remove old pods until new ones are ready
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: web
        environment: production
        tier: frontend
    spec:
      # Schedule on user node pool
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: agentpool
                    operator: In
                    values:
                      - user
        # Spread pods across nodes for HA
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: web
                topologyKey: kubernetes.io/hostname
      containers:
        - name: web
          # Use immutable SHA tag - NEVER use 'latest'
          image: acrunifiedhealthdev2.azurecr.io/unifiedhealth/web:23dd925
          # IfNotPresent for immutable tags to reduce pull overhead
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
              name: http
              protocol: TCP
          # Resource requests and limits - right-sized for Next.js
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          # Readiness probe - checks real app health
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          # Liveness probe - checks process health only
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 15
            periodSeconds: 20
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          # Startup probe - allows slow startup without killing pod
          startupProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 30
          env:
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "3000"
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false
      # Graceful shutdown
      terminationGracePeriodSeconds: 30
      # Service account
      serviceAccountName: default
      # Security context for pod
      securityContext:
        fsGroup: 1001
