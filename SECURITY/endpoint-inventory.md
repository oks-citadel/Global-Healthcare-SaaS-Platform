# Endpoint Security Inventory

**Generated:** 2024-12-23
**Last Updated:** Auto-generated by Security Agent
**Status:** Active Monitoring

---

## Overview

This document provides a comprehensive inventory of all API endpoints in the UnifiedHealth platform, including their authentication requirements, authorization policies, input validation, and security status.

---

## Security Status Legend

| Status   | Description                                       |
| -------- | ------------------------------------------------- |
| SECURE   | Fully hardened with DTO, AuthZ, and audit logging |
| HARDENED | Basic protections in place, audit logging added   |
| REVIEW   | Requires security review                          |
| CRITICAL | Known vulnerability, remediation in progress      |

---

## API Service Endpoints (Port 8080)

### Authentication Endpoints

| Route            | Method | Auth | Roles  | DTO Schema           | Security Status | Notes                                       |
| ---------------- | ------ | ---- | ------ | -------------------- | --------------- | ------------------------------------------- |
| `/auth/register` | POST   | None | Public | `RegisterSchema`     | **CRITICAL**    | Mass assignment: role field must be removed |
| `/auth/login`    | POST   | None | Public | `LoginSchema`        | SECURE          | Rate limited (5/15min)                      |
| `/auth/refresh`  | POST   | None | Public | `RefreshTokenSchema` | SECURE          | Token rotation enabled                      |
| `/auth/logout`   | POST   | JWT  | All    | None                 | SECURE          |                                             |
| `/auth/me`       | GET    | JWT  | All    | None                 | SECURE          |                                             |
| `/roles`         | GET    | JWT  | Admin  | None                 | SECURE          | Admin-only                                  |

### User Endpoints

| Route        | Method | Auth | Roles       | DTO Schema         | Security Status | Notes                            |
| ------------ | ------ | ---- | ----------- | ------------------ | --------------- | -------------------------------- |
| `/users/:id` | GET    | JWT  | Owner/Admin | None               | HARDENED        | Ownership check in place         |
| `/users/:id` | PATCH  | JWT  | Owner/Admin | `UpdateUserSchema` | **REVIEW**      | Verify role/status not updatable |

### Patient Endpoints

| Route           | Method | Auth | Roles                | DTO Schema            | Security Status | Notes                    |
| --------------- | ------ | ---- | -------------------- | --------------------- | --------------- | ------------------------ |
| `/patients`     | POST   | JWT  | All                  | `CreatePatientSchema` | HARDENED        | Ownership enforced       |
| `/patients/:id` | GET    | JWT  | Owner/Provider/Admin | None                  | HARDENED        | IDOR protection in place |
| `/patients/:id` | PATCH  | JWT  | Owner/Provider/Admin | `UpdatePatientSchema` | HARDENED        | Ownership check          |

### Encounter Endpoints

| Route                   | Method | Auth | Roles                | DTO Schema              | Security Status | Notes                         |
| ----------------------- | ------ | ---- | -------------------- | ----------------------- | --------------- | ----------------------------- |
| `/encounters`           | POST   | JWT  | Provider/Admin       | `CreateEncounterSchema` | **REVIEW**      | State machine needed          |
| `/encounters`           | GET    | JWT  | All (filtered)       | Query params            | HARDENED        | Role-based filtering          |
| `/encounters/:id`       | GET    | JWT  | Owner/Provider/Admin | None                    | HARDENED        | Access control in place       |
| `/encounters/:id`       | PATCH  | JWT  | Provider/Admin       | `UpdateEncounterSchema` | **REVIEW**      | State transitions unvalidated |
| `/encounters/:id/notes` | POST   | JWT  | Provider/Admin       | `AddClinicalNoteSchema` | HARDENED        |                               |
| `/encounters/:id/notes` | GET    | JWT  | Owner/Provider/Admin | None                    | HARDENED        |                               |
| `/encounters/:id/start` | POST   | JWT  | Provider/Admin       | None                    | **CRITICAL**    | No state validation           |
| `/encounters/:id/end`   | POST   | JWT  | Provider/Admin       | None                    | **CRITICAL**    | No state validation           |

### Appointment Endpoints

| Route               | Method | Auth | Roles                | DTO Schema                | Security Status | Notes                   |
| ------------------- | ------ | ---- | -------------------- | ------------------------- | --------------- | ----------------------- |
| `/appointments`     | POST   | JWT  | All                  | `CreateAppointmentSchema` | **REVIEW**      | Verify tenant isolation |
| `/appointments`     | GET    | JWT  | All (filtered)       | `ListAppointmentsSchema`  | HARDENED        | Role-based filtering    |
| `/appointments/:id` | GET    | JWT  | Owner/Provider/Admin | None                      | HARDENED        | Access control in place |
| `/appointments/:id` | PATCH  | JWT  | Owner/Provider/Admin | `UpdateAppointmentSchema` | **REVIEW**      | State transitions       |
| `/appointments/:id` | DELETE | JWT  | Owner/Provider/Admin | None                      | HARDENED        | Soft delete only        |

### Document Endpoints

| Route                            | Method | Auth | Roles                | DTO Schema   | Security Status | Notes                 |
| -------------------------------- | ------ | ---- | -------------------- | ------------ | --------------- | --------------------- |
| `/documents`                     | POST   | JWT  | All                  | File upload  | HARDENED        | Malware scan optional |
| `/documents`                     | GET    | JWT  | All (filtered)       | Query params | HARDENED        |                       |
| `/documents/:id`                 | GET    | JWT  | Owner/Provider/Admin | None         | HARDENED        |                       |
| `/documents/:id/download`        | GET    | JWT  | Owner/Provider/Admin | None         | HARDENED        | Pre-signed URLs       |
| `/documents/:id`                 | DELETE | JWT  | Owner/Provider/Admin | None         | HARDENED        |                       |
| `/patients/:patientId/documents` | GET    | JWT  | Owner/Provider/Admin | None         | **REVIEW**      | Verify patient access |

### Subscription & Payment Endpoints

| Route                           | Method | Auth       | Roles  | DTO Schema                 | Security Status | Notes                         |
| ------------------------------- | ------ | ---------- | ------ | -------------------------- | --------------- | ----------------------------- |
| `/plans`                        | GET    | None       | Public | None                       | SECURE          | Read-only                     |
| `/subscriptions`                | POST   | JWT        | All    | `CreateSubscriptionSchema` | **REVIEW**      | Coupon validation server-side |
| `/subscriptions/:id`            | DELETE | JWT        | Owner  | None                       | HARDENED        | Owner check                   |
| `/billing/webhook`              | POST   | Stripe Sig | N/A    | Raw body                   | SECURE          | Signature verification        |
| `/payments/config`              | GET    | None       | Public | None                       | SECURE          | Public key only               |
| `/payments/setup-intent`        | POST   | JWT        | All    | None                       | HARDENED        |                               |
| `/payments/subscription`        | POST   | JWT        | All    | None                       | **REVIEW**      | Verify server-side pricing    |
| `/payments/subscription`        | GET    | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/subscription`        | DELETE | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/payment-method`      | POST   | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/payment-method/save` | POST   | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/payment-methods`     | GET    | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/payment-method/:id`  | DELETE | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/charge`              | POST   | JWT        | All    | None                       | **CRITICAL**    | Verify amount server-side     |
| `/payments/history`             | GET    | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/:id`                 | GET    | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/:id/refund`          | POST   | JWT        | Admin  | None                       | **REVIEW**      | Should be admin-only          |
| `/payments/invoices`            | GET    | JWT        | Owner  | None                       | HARDENED        |                               |
| `/payments/webhook`             | POST   | Stripe Sig | N/A    | Raw body                   | SECURE          |                               |

### Notification Endpoints

| Route                           | Method | Auth | Roles | DTO Schema | Security Status | Notes      |
| ------------------------------- | ------ | ---- | ----- | ---------- | --------------- | ---------- |
| `/notifications/email`          | POST   | JWT  | Admin | Email DTO  | SECURE          | Admin-only |
| `/notifications/sms`            | POST   | JWT  | Admin | SMS DTO    | SECURE          | Admin-only |
| `/notifications/email/batch`    | POST   | JWT  | Admin | Batch DTO  | SECURE          | Admin-only |
| `/notifications/sms/batch`      | POST   | JWT  | Admin | Batch DTO  | SECURE          | Admin-only |
| `/notifications/sms/:id/status` | GET    | JWT  | Admin | None       | SECURE          | Admin-only |

### Audit Endpoints

| Route           | Method | Auth | Roles | DTO Schema   | Security Status | Notes                 |
| --------------- | ------ | ---- | ----- | ------------ | --------------- | --------------------- |
| `/audit/events` | GET    | JWT  | Admin | Query params | SECURE          | Admin-only, immutable |

### Consent Endpoints

| Route           | Method | Auth | Roles       | DTO Schema  | Security Status | Notes |
| --------------- | ------ | ---- | ----------- | ----------- | --------------- | ----- |
| `/consents`     | POST   | JWT  | All         | Consent DTO | HARDENED        |       |
| `/consents/:id` | GET    | JWT  | Owner/Admin | None        | HARDENED        |       |

### Push Notification Endpoints

| Route                               | Method | Auth | Roles | DTO Schema | Security Status | Notes      |
| ----------------------------------- | ------ | ---- | ----- | ---------- | --------------- | ---------- |
| `/push/register`                    | POST   | JWT  | All   | Device DTO | HARDENED        |            |
| `/push/unregister`                  | DELETE | JWT  | Owner | None       | HARDENED        |            |
| `/push/devices`                     | GET    | JWT  | Owner | None       | HARDENED        |            |
| `/push/notifications`               | GET    | JWT  | Owner | None       | HARDENED        |            |
| `/push/notifications/:id/read`      | PATCH  | JWT  | Owner | None       | HARDENED        |            |
| `/push/notifications/mark-all-read` | POST   | JWT  | Owner | None       | HARDENED        |            |
| `/push/unread-count`                | GET    | JWT  | Owner | None       | HARDENED        |            |
| `/push/preferences`                 | GET    | JWT  | Owner | None       | HARDENED        |            |
| `/push/preferences`                 | PUT    | JWT  | Owner | Prefs DTO  | HARDENED        |            |
| `/push/send`                        | POST   | JWT  | Admin | Push DTO   | SECURE          | Admin-only |
| `/push/send-batch`                  | POST   | JWT  | Admin | Batch DTO  | SECURE          | Admin-only |

### Dashboard Endpoints

| Route                      | Method | Auth | Roles | DTO Schema | Security Status | Notes                 |
| -------------------------- | ------ | ---- | ----- | ---------- | --------------- | --------------------- |
| `/dashboard/stats`         | GET    | JWT  | All   | None       | HARDENED        | Role-filtered data    |
| `/dashboard/quick-actions` | GET    | JWT  | All   | None       | HARDENED        | Role-filtered actions |

### Health & Config Endpoints

| Route            | Method | Auth | Roles  | DTO Schema | Security Status | Notes              |
| ---------------- | ------ | ---- | ------ | ---------- | --------------- | ------------------ |
| `/version`       | GET    | None | Public | None       | SECURE          |                    |
| `/config/public` | GET    | None | Public | None       | SECURE          | No secrets exposed |
| `/health`        | GET    | None | Public | None       | SECURE          | Rate limit exempt  |

---

## Critical Vulnerabilities Identified

### 1. Mass Assignment - Role Escalation (CRITICAL)

- **Location:** `services/api/src/dtos/auth.dto.ts:10`
- **Issue:** RegisterSchema accepts `role` field from user input
- **Impact:** Users can self-assign admin role during registration
- **Fix:** Remove role from RegisterSchema, set server-side

### 2. Encounter State Machine Missing (CRITICAL)

- **Location:** `services/api/src/controllers/encounter.controller.ts`
- **Issue:** start/end endpoints don't validate current state
- **Impact:** Invalid state transitions possible
- **Fix:** Implement state machine with valid transitions

### 3. Payment Amount Tampering (CRITICAL)

- **Location:** Payment endpoints
- **Issue:** Amount may be accepted from client
- **Impact:** Users could manipulate payment amounts
- **Fix:** Always compute amounts server-side

### 4. Missing Audit Logging

- **Location:** Multiple controllers
- **Issue:** Critical operations not logged
- **Impact:** No traceability for security events
- **Fix:** Add audit middleware for all sensitive operations

---

## Server-Owned Fields (Never Accept from Client)

The following fields must NEVER be set via client input:

```typescript
const SERVER_OWNED_FIELDS = [
  // Identity & Access
  "role",
  "isAdmin",
  "permissions",
  "status",
  "emailVerified",
  "phoneVerified",

  // Ownership
  "userId",
  "tenantId",
  "ownerId",
  "createdBy",
  "updatedBy",

  // Approval & Workflow
  "approved",
  "approvedBy",
  "approvedAt",
  "verified",
  "verifiedBy",
  "verifiedAt",
  "reviewStatus",
  "reviewedBy",

  // Subscription & Billing
  "subscriptionTier",
  "subscriptionStatus",
  "billingStatus",
  "quota",
  "credits",
  "balance",
  "discount",
  "priceOverride",

  // System Fields
  "id",
  "createdAt",
  "updatedAt",
  "deletedAt",
  "version",

  // Security
  "passwordHash",
  "passwordResetToken",
  "emailVerificationToken",
  "refreshTokenHash",
  "lastLoginAt",
  "failedLoginAttempts",
  "lockedUntil",
];
```

---

## Tenant Isolation Requirements

All queries MUST include tenant scoping:

```typescript
// Required query pattern
prisma.resource.findMany({
  where: {
    tenantId: req.user.tenantId, // ALWAYS include
    ...otherFilters,
  },
});
```

---

## State Machine Requirements

### Encounter States

```
SCHEDULED -> IN_PROGRESS -> COMPLETED
                        -> CANCELLED

Valid Transitions:
- SCHEDULED -> IN_PROGRESS (start)
- SCHEDULED -> CANCELLED (cancel)
- IN_PROGRESS -> COMPLETED (end)
- IN_PROGRESS -> CANCELLED (cancel)
```

### Appointment States

```
PENDING -> CONFIRMED -> CHECKED_IN -> IN_PROGRESS -> COMPLETED
                                                  -> NO_SHOW
                    -> CANCELLED

Valid Transitions:
- PENDING -> CONFIRMED (confirm)
- PENDING -> CANCELLED (cancel)
- CONFIRMED -> CHECKED_IN (checkIn)
- CONFIRMED -> CANCELLED (cancel)
- CHECKED_IN -> IN_PROGRESS (start)
- CHECKED_IN -> NO_SHOW (markNoShow)
- IN_PROGRESS -> COMPLETED (complete)
```

### Subscription States

```
TRIAL -> ACTIVE -> PAST_DUE -> CANCELLED
               -> CANCELLED

Valid Transitions:
- TRIAL -> ACTIVE (activate)
- TRIAL -> CANCELLED (cancel)
- ACTIVE -> PAST_DUE (paymentFailed)
- ACTIVE -> CANCELLED (cancel)
- PAST_DUE -> ACTIVE (paymentSucceeded)
- PAST_DUE -> CANCELLED (cancel after grace period)
```

---

## Revision History

| Date       | Change                    | Author         |
| ---------- | ------------------------- | -------------- |
| 2024-12-23 | Initial inventory created | Security Agent |
